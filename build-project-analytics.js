#!/usr/bin/env node
/**
 * Скрипт сборки ujg-project-analytics.js из модулей
 * Использование: node build-project-analytics.js
 */

var fs = require('fs');
var path = require('path');

var MODULES_DIR = path.join(__dirname, 'ujg-project-analytics-modules');
var OUTPUT_FILE = path.join(__dirname, 'ujg-project-analytics.js');

// Порядок загрузки модулей (важен для зависимостей)
var MODULE_ORDER = [
    'config.js',
    'utils.js',
    'storage.js',
    'workflow.js',
    'api-tracker.js',
    'progress-modal.js',
    'settings-modal.js',
    'data-collection.js',
    'basic-analytics.js',
    'dev-cycle.js',
    'developer-analytics.js',
    'bottlenecks.js',
    'risk-assessment.js',
    'team-metrics.js',
    'velocity.js',
    'rendering.js',
    'main.js'
];

function readModule(fileName) {
    var filePath = path.join(MODULES_DIR, fileName);
    if (!fs.existsSync(filePath)) {
        console.warn('Warning: Module not found:', fileName);
        return '';
    }
    return fs.readFileSync(filePath, 'utf8');
}

function build() {
    console.log('Building ujg-project-analytics.js from modules...');

    // ВАЖНО: не "распаковываем" AMD define() в один scope.
    // В одном файле можно объявить много AMD модулей через define().
    // Так мы избегаем конфликтов переменных и проблем с return внутри модулей.
    var parts = [
        '// Auto-generated file - DO NOT EDIT MANUALLY',
        '// Generated by build-project-analytics.js',
        '// To modify, edit files in ujg-project-analytics-modules/ and rebuild',
        ''
    ];

    // Добавляем все модули как есть, в фиксированном порядке
    MODULE_ORDER.forEach(function(fileName) {
        var content = readModule(fileName);
        if (!content) return;
        parts.push('/* === Module: ' + fileName + ' === */');
        parts.push(content.trim());
        parts.push('');
    });

    // Финальный публичный модуль, который ожидает Jira (конструктор гаджета)
    parts.push('define("_ujgProjectAnalytics", ["_ujgPA_main"], function(MyGadget) {');
    parts.push('    "use strict";');
    parts.push('    return MyGadget;');
    parts.push('});');
    parts.push('');

    var fullContent = parts.join('\n');
    
    // Записываем результат
    fs.writeFileSync(OUTPUT_FILE, fullContent, 'utf8');
    
    console.log('✓ Built successfully:', OUTPUT_FILE);
    console.log('  Total size:', (fullContent.length / 1024).toFixed(2), 'KB');
    console.log('  Modules processed:', MODULE_ORDER.filter(function(f) {
        return fs.existsSync(path.join(MODULES_DIR, f));
    }).length);
}

// Запускаем сборку
if (require.main === module) {
    build();
}

module.exports = { build: build };
