#!/usr/bin/env node
/**
 * Скрипт сборки ujg-project-analytics.js из модулей
 * Использование: node build-project-analytics.js
 */

var fs = require('fs');
var path = require('path');

var MODULES_DIR = path.join(__dirname, 'ujg-project-analytics-modules');
var OUTPUT_FILE = path.join(__dirname, 'ujg-project-analytics.js');

// Порядок загрузки модулей (важен для зависимостей)
var MODULE_ORDER = [
    'config.js',
    'utils.js',
    'storage.js',
    'workflow.js',
    'api-tracker.js',
    'progress-modal.js',
    'settings-modal.js',
    'data-collection.js',
    'basic-analytics.js',
    'dev-cycle.js',
    'developer-analytics.js',
    'bottlenecks.js',
    'risk-assessment.js',
    'team-metrics.js',
    'velocity.js',
    'rendering.js',
    'main.js'
];

function readModule(fileName) {
    var filePath = path.join(MODULES_DIR, fileName);
    if (!fs.existsSync(filePath)) {
        console.warn('Warning: Module not found:', fileName);
        return '';
    }
    return fs.readFileSync(filePath, 'utf8');
}

function extractModuleBody(content) {
    // Ищем паттерн: define("...", [...], function(...) { ... return {...}; });
    var match = content.match(/define\([^)]+,\s*function\s*\([^)]*\)\s*\{([\s\S]*)\}\s*\)\s*;?\s*$/);
    if (!match) return null;
    
    var body = match[1];
    // Удаляем "use strict" если есть
    body = body.replace(/^\s*"use strict";\s*/m, '');
    
    // Удаляем return statement в конце модуля
    // Ищем последний return перед закрывающей скобкой функции
    // Сначала попробуем найти return с объектом
    var lines = body.split('\n');
    var returnStartIndex = -1;
    for (var i = lines.length - 1; i >= 0; i--) {
        if (lines[i].match(/^\s*return\s+/)) {
            returnStartIndex = i;
            break;
        }
    }
    
    if (returnStartIndex >= 0) {
        // Удаляем все строки начиная с return
        body = lines.slice(0, returnStartIndex).join('\n');
    } else {
        // Попробуем regex подход
        body = body.replace(/\s*return\s+\{[\s\S]*?\}\s*;\s*$/m, '');
        body = body.replace(/\s*return\s+[^;{}]*;\s*$/m, '');
        body = body.replace(/\s*return\s+[^;{}]*\s*$/m, '');
    }
    
    return body.trim();
}

function build() {
    console.log('Building ujg-project-analytics.js from modules...');
    
    var header = [
        '// Auto-generated file - DO NOT EDIT MANUALLY',
        '// Generated by build-project-analytics.js',
        '// To modify, edit files in ujg-project-analytics-modules/ and rebuild',
        '',
        'define("_ujgProjectAnalytics", ["jquery", "_ujgCommon"], function($, Common) {',
        '    "use strict";',
        '    ',
        '    if (typeof $ === "undefined" || !$) {',
        '        console.error("[UJG-ProjectAnalytics] jQuery is not loaded!");',
        '        return function() { console.error("jQuery required"); };',
        '    }',
        '    ',
        '    if (!Common || !Common.utils) {',
        '        console.error("[UJG-ProjectAnalytics] _ujgCommon is not loaded!");',
        '        return function() { console.error("_ujgCommon required"); };',
        '    }',
        '    ',
        '    var utils = Common.utils;',
        '    var baseUrl = Common.baseUrl || "";',
        ''
    ].join('\n');
    
    var footer = [
        '',
        '    return MyGadget;',
        '});'
    ].join('\n');
    
    var modulesContent = [];
    var moduleVars = {};
    
    // Читаем все модули в правильном порядке
    MODULE_ORDER.forEach(function(fileName) {
        var content = readModule(fileName);
        if (content) {
            var moduleBody = extractModuleBody(content);
            if (moduleBody) {
                // Создаем переменные для модулей, которые возвращают объекты
                if (fileName === 'config.js') {
                    modulesContent.push('    // === Module: ' + fileName + ' ===');
                    modulesContent.push('    var config = ' + moduleBody + ';');
                    modulesContent.push('');
                } else {
                    modulesContent.push('    // === Module: ' + fileName + ' ===');
                    modulesContent.push(moduleBody);
                    modulesContent.push('');
                }
            } else {
                // Если не AMD модуль, просто добавляем содержимое
                modulesContent.push('    // === Module: ' + fileName + ' ===');
                modulesContent.push(content.trim());
                modulesContent.push('');
            }
        }
    });
    
    var fullContent = header + modulesContent.join('\n') + footer;
    
    // Записываем результат
    fs.writeFileSync(OUTPUT_FILE, fullContent, 'utf8');
    
    console.log('✓ Built successfully:', OUTPUT_FILE);
    console.log('  Total size:', (fullContent.length / 1024).toFixed(2), 'KB');
    console.log('  Modules processed:', MODULE_ORDER.filter(function(f) {
        return fs.existsSync(path.join(MODULES_DIR, f));
    }).length);
}

// Запускаем сборку
if (require.main === module) {
    build();
}

module.exports = { build: build };
