# UJG Project Analytics Dashboard — Глубинная аналитика проекта

## Цель
Создать дашборд, который выявляет **скрытые проблемы в процессе разработки** путём детального анализа активности по каждой задаче за выбранный период. Не просто показать статусы, а понять:
- Где процесс буксует
- Кто блокирует работу
- Какие задачи "зависают" и почему
- Насколько эффективно работает команда

---

## Скелет главных идей дашборда

### ⚙️ Блок 0: Workflow Configuration (Конфигурация статусов)
Гибкая настройка категорий статусов для любого workflow проекта

### 🎯 Блок 1: Сбор данных с визуализацией прогресса
Модальное окно с live-статистикой загрузки данных

### 🔍 Блок 2: Activity Deep Dive (Анализ активности)
Кто что делал: переводы статусов, назначения, изменения спринтов

### ⏱️ Блок 3: Time Distribution (Распределение времени)
Сколько времени задача висела на каждом исполнителе/статусе

### 💻 Блок 4: Development Cycle Analysis (Цикл разработки)
Коммиты, ревью, возвраты, связь с PR/MR

### 🔄 Блок 5: Workflow Bottlenecks (Узкие места процесса)
Выявление паттернов застревания и блокировок

### 📊 Блок 6: Team Performance Insights (Эффективность команды)
Метрики по участникам: скорость, качество, нагрузка

### ⚠️ Блок 7: Risk Indicators (Индикаторы рисков)
Автоматическое выявление проблемных кейсов

### 📈 Блок 8: Trend Analysis (Тренды)
Сравнение периодов, динамика улучшений/ухудшений

---

## Детальная проработка блоков

---

## Блок 0: Workflow Configuration (Конфигурация статусов)

### Проблема
В разных проектах Jira используются разные workflow с разными названиями статусов:
- Проект A: `To Do → In Progress → Code Review → QA → Done`
- Проект B: `Открыт → В работе → На ревью → Тестирование → Закрыт`
- Проект C: `Backlog → Development → Review → Staging → Production`

**Нельзя хардкодить конкретные названия статусов!**

### Решение: Категории статусов

Вместо привязки к конкретным статусам, используем **категории** (группы статусов).
Пользователь сам определяет какие статусы проекта относятся к какой категории.

#### Категории статусов

| Категория | Код | Описание | Для чего используется |
|-----------|-----|----------|----------------------|
| **Очередь** | `queue` | Задача ждёт начала работы | Lead Time (начало отсчёта) |
| **В работе** | `work` | Активная разработка | Cycle Time, WIP |
| **Ревью** | `review` | Code Review, проверка | Bottleneck detection |
| **Тестирование** | `testing` | QA, тестирование | Bottleneck, возвраты |
| **Ожидание** | `waiting` | Blocked, On Hold | Wait Time |
| **Завершено** | `done` | Закрыто, готово | Lead Time (конец), Reopen detection |

#### Важно: категории опциональны!
- Не каждый проект имеет все категории
- Если категории нет — связанные метрики просто не считаются
- Один статус может быть в нескольких категориях (редко, но возможно)
- Статус может не принадлежать ни одной категории (будет просто отображаться как есть)

### Структура конфигурации

```javascript
// Хранится в localStorage по ключу: ujg_pa_workflow_{projectKey}
var workflowConfig = {
    projectKey: "PROJ",
    lastUpdated: "2024-12-30T10:00:00",
    
    // Все статусы проекта (автоматически собираются из задач)
    allStatuses: ["To Do", "In Progress", "Code Review", "QA", "Done", "Blocked"],
    
    // Маппинг статусов на категории
    statusCategories: {
        "To Do": ["queue"],
        "Backlog": ["queue"],
        "In Progress": ["work"],
        "Development": ["work"],
        "Code Review": ["review"],
        "На ревью": ["review"],
        "QA": ["testing"],
        "Testing": ["testing"],
        "Тестирование": ["testing"],
        "Blocked": ["waiting"],
        "On Hold": ["waiting"],
        "Done": ["done"],
        "Closed": ["done"],
        "Resolved": ["done"],
        "Готово": ["done"],
        "Закрыт": ["done"]
    },
    
    // Обратный индекс: категория → статусы
    categoryStatuses: {
        "queue": ["To Do", "Backlog"],
        "work": ["In Progress", "Development"],
        "review": ["Code Review", "На ревью"],
        "testing": ["QA", "Testing", "Тестирование"],
        "waiting": ["Blocked", "On Hold"],
        "done": ["Done", "Closed", "Resolved", "Готово", "Закрыт"]
    }
};
```

### UI: Настройка Workflow

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ ⚙️ НАСТРОЙКА WORKFLOW                                    [Сохранить] [Сбросить] │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Проект: PROJ (Найдено 8 уникальных статусов)                                  │
│                                                                                 │
│  Распределите статусы по категориям (drag & drop или клик):                    │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                                                                         │   │
│  │  📥 ОЧЕРЕДЬ (queue)           📋 В РАБОТЕ (work)                       │   │
│  │  ┌─────────────────────┐      ┌─────────────────────┐                  │   │
│  │  │ [To Do        ] [×] │      │ [In Progress  ] [×] │                  │   │
│  │  │ [Backlog      ] [×] │      │ [Development  ] [×] │                  │   │
│  │  │ [+ добавить]        │      │ [+ добавить]        │                  │   │
│  │  └─────────────────────┘      └─────────────────────┘                  │   │
│  │                                                                         │   │
│  │  🔍 РЕВЬЮ (review)            🧪 ТЕСТИРОВАНИЕ (testing)                │   │
│  │  ┌─────────────────────┐      ┌─────────────────────┐                  │   │
│  │  │ [Code Review  ] [×] │      │ [QA           ] [×] │                  │   │
│  │  │ [На ревью     ] [×] │      │ [Testing      ] [×] │                  │   │
│  │  │ [+ добавить]        │      │ [+ добавить]        │                  │   │
│  │  └─────────────────────┘      └─────────────────────┘                  │   │
│  │                                                                         │   │
│  │  ⏸️ ОЖИДАНИЕ (waiting)        ✅ ЗАВЕРШЕНО (done)                      │   │
│  │  ┌─────────────────────┐      ┌─────────────────────┐                  │   │
│  │  │ [Blocked      ] [×] │      │ [Done         ] [×] │                  │   │
│  │  │ [On Hold      ] [×] │      │ [Closed       ] [×] │                  │   │
│  │  │ [+ добавить]        │      │ [Resolved     ] [×] │                  │   │
│  │  └─────────────────────┘      │ [+ добавить]        │                  │   │
│  │                               └─────────────────────┘                  │   │
│  │                                                                         │   │
│  │  ❓ НЕ РАСПРЕДЕЛЕНЫ (не обязательно распределять)                      │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │ [Draft] [Pending] [Под вопросом]                                │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  💡 Подсказка: категории используются для расчёта метрик.                       │
│     Если категория пустая — связанные метрики не будут рассчитаны.             │
│     Это нормально, если в вашем workflow нет такого этапа.                      │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Auto-suggest статусов

При первой загрузке данных система пытается автоматически распределить статусы:

```javascript
// Паттерны для автоматического распознавания
var STATUS_PATTERNS = {
    queue: [/to\s*do/i, /backlog/i, /open/i, /new/i, /создан/i, /открыт/i, /очередь/i],
    work: [/in\s*progress/i, /progress/i, /develop/i, /в\s*работе/i, /разработка/i, /working/i],
    review: [/review/i, /ревью/i, /проверк/i, /code\s*review/i],
    testing: [/test/i, /qa/i, /тест/i, /quality/i, /验证/],
    waiting: [/block/i, /hold/i, /wait/i, /pending/i, /ожидан/i, /заблок/i],
    done: [/done/i, /close/i, /resolve/i, /complete/i, /готово/i, /закрыт/i, /выполнен/i, /завершен/i]
};

function autoSuggestCategory(statusName) {
    for (var category in STATUS_PATTERNS) {
        for (var i = 0; i < STATUS_PATTERNS[category].length; i++) {
            if (STATUS_PATTERNS[category][i].test(statusName)) {
                return category;
            }
        }
    }
    return null; // Не удалось определить
}
```

### Использование категорий в аналитике

```javascript
// Пример: расчёт Cycle Time
function calculateCycleTime(issue, config) {
    var workStatuses = config.categoryStatuses["work"] || [];
    var doneStatuses = config.categoryStatuses["done"] || [];
    
    // Если нет категории "work" или "done" — не можем посчитать
    if (workStatuses.length === 0 || doneStatuses.length === 0) {
        return null; // Метрика недоступна для этого проекта
    }
    
    var startWork = null;
    var endWork = null;
    
    issue.changelog.statusChanges.forEach(function(change) {
        // Первый переход в любой статус из категории "work"
        if (!startWork && workStatuses.indexOf(change.to) >= 0) {
            startWork = change.at;
        }
        // Первый переход в любой статус из категории "done"
        if (!endWork && doneStatuses.indexOf(change.to) >= 0) {
            endWork = change.at;
        }
    });
    
    if (startWork && endWork) {
        return daysBetween(startWork, endWork);
    }
    return null;
}

// Пример: определение возврата (reopen)
function detectReopen(issue, config) {
    var doneStatuses = config.categoryStatuses["done"] || [];
    var workStatuses = config.categoryStatuses["work"] || [];
    
    if (doneStatuses.length === 0) return false;
    
    var wasDone = false;
    var reopens = 0;
    
    issue.changelog.statusChanges.forEach(function(change) {
        if (doneStatuses.indexOf(change.from) >= 0 && 
            (workStatuses.indexOf(change.to) >= 0 || doneStatuses.indexOf(change.to) < 0)) {
            // Переход ИЗ done в НЕ-done
            reopens++;
        }
        if (doneStatuses.indexOf(change.to) >= 0) {
            wasDone = true;
        }
    });
    
    return { wasDone: wasDone, reopens: reopens };
}
```

### Fallback поведение

Если конфигурация не настроена или категория пустая:

| Метрика | Поведение при отсутствии категории |
|---------|-----------------------------------|
| Cycle Time | Показываем "—" или "Настройте workflow" |
| Lead Time | Работает всегда (created → последний статус из done или текущий) |
| Time in Status | Работает всегда (показываем все статусы как есть) |
| Reopen detection | Не работает без категории "done" |
| Review bottleneck | Не работает без категории "review" |
| WIP count | Работает если есть категория "work", иначе считаем все не-done |

### Задачи блока
- [x] 0.1 Структура хранения конфигурации в localStorage
- [x] 0.2 UI для настройки workflow (drag & drop)
- [x] 0.3 Авто-определение статусов при первой загрузке
- [x] 0.4 Функции-хелперы для работы с категориями
- [x] 0.5 Fallback логика для отсутствующих категорий
- [ ] 0.6 Миграция конфигурации при добавлении новых статусов

---

## Блок 1: Data Collection Progress (Сбор данных)

### Проблема
Для глубинной аналитики нужно много запросов к API Jira:
- Список задач (1 запрос)
- История изменений каждой задачи `/issue/{key}/changelog` (N запросов)
- Worklogs `/issue/{key}/worklog` (N запросов)
- Dev-связи `/dev-status/1.0/issue/detail` (N запросов)

При 100+ задачах это 300+ запросов, пользователь должен понимать что происходит.

### Решение: Модальное окно прогресса

```
┌─────────────────────────────────────────────────────────────────┐
│  🔄 Сбор данных для аналитики                              [×]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ████████████████████░░░░░░░░░░  67%                           │
│                                                                 │
│  Этап: Загрузка истории изменений                              │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ API Endpoint           │ Calls │ Done │ Errors │ Avg ms │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ /rest/api/2/search     │   1   │  ✓   │   0    │  420   │   │
│  │ /rest/api/2/issue/*/   │  87   │  58  │   1    │  180   │   │
│  │   changelog            │       │      │        │        │   │
│  │ /rest/api/2/issue/*/   │  87   │  87  │   0    │  95    │   │
│  │   worklog              │       │      │        │        │   │
│  │ /rest/dev-status/...   │  87   │   0  │   0    │   -    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Обработано задач: 58 / 87                                     │
│  Время: 00:42 | Осталось: ~00:25                               │
│                                                                 │
│  [Прервать]                                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Технические требования

```javascript
// Структура трекера запросов
var apiTracker = {
    endpoints: {
        'search': { calls: 0, done: 0, errors: 0, totalMs: 0 },
        'changelog': { calls: 0, done: 0, errors: 0, totalMs: 0 },
        'worklog': { calls: 0, done: 0, errors: 0, totalMs: 0 },
        'dev-status': { calls: 0, done: 0, errors: 0, totalMs: 0 }
    },
    issues: { total: 0, processed: 0 },
    startTime: null,
    
    track: function(endpoint, status, ms) { /* ... */ },
    getProgress: function() { /* ... */ },
    getETA: function() { /* ... */ }
};
```

### Задачи блока
- [x] 1.1 Создать компонент модального окна
- [x] 1.2 Реализовать API-трекер с подсчётом запросов
- [x] 1.3 Добавить расчёт ETA и среднего времени
- [x] 1.4 Обработка отмены загрузки
- [x] 1.5 Graceful degradation при ошибках

---

## Блок 2: Activity Deep Dive (Анализ активности)

### Источник данных
`GET /rest/api/2/issue/{key}?expand=changelog`

### Что анализируем в changelog

| Поле (field) | Что отслеживаем | Какую проблему выявляем |
|--------------|-----------------|-------------------------|
| `status` | Переходы между статусами | Сколько раз возвращали, среднее время в статусе |
| `assignee` | Смены исполнителя | "Футбол" задачами между людьми |
| `Sprint` | Перенос между спринтами | Задачи-путешественники |
| `priority` | Изменение приоритета | Неконтролируемая эскалация |
| `Fix Version` | Перенос релиза | Scope creep, невыполнение обязательств |
| `resolution` | Reopen после закрытия | Качество работы |

### Метрики активности за период

#### По задаче:
```javascript
{
    key: "PROJ-123",
    activityInPeriod: {
        statusChanges: [
            { from: "To Do", to: "In Progress", by: "ivanov", at: "2024-01-15T10:00:00", daysInPrevStatus: 3 },
            { from: "In Progress", to: "Code Review", by: "ivanov", at: "2024-01-17T16:00:00", daysInPrevStatus: 2 }
        ],
        assigneeChanges: [
            { from: "petrov", to: "ivanov", by: "pm", at: "2024-01-14T09:00:00" }
        ],
        sprintChanges: [
            { from: "Sprint 5", to: "Sprint 6", by: "pm", at: "2024-01-10T11:00:00" }
        ],
        reopens: 0,
        totalChanges: 5
    }
}
```

#### Агрегированные метрики:
- **Коэффициент "футбола"**: среднее количество смен assignee на задачу
- **Коэффициент переноса**: % задач, менявших спринт
- **Коэффициент реопена**: % задач, которые возвращались после закрытия
- **Топ "перекладывателей"**: кто чаще всего перенаправляет задачи

### UI: Таблица активности

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 🔍 АНАЛИЗ АКТИВНОСТИ ЗА ПЕРИОД: 01.12.2024 — 31.12.2024                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Фильтры: [Все типы ▼] [Все исполнители ▼] [Все авторы изменений ▼]           │
│                                                                                 │
│  ┌────────┬────────────────┬─────────────────────────────────────────────────┐  │
│  │ Задача │ Summary        │ Активность за период                            │  │
│  ├────────┼────────────────┼─────────────────────────────────────────────────┤  │
│  │PROJ-45 │ Баг в логине   │ 🔄×3 статуса  👤×2 assignee  🏃×1 спринт  ⟲×1   │  │
│  │        │                │ Timeline: ────[▓▓▓▓░░░░▓▓▓▓]────               │  │
│  │        │                │ Детали: In Progress→Review→In Progress→Done     │  │
│  ├────────┼────────────────┼─────────────────────────────────────────────────┤  │
│  │PROJ-67 │ Новая фича     │ 🔄×1 статуса  👤×0 assignee  🏃×2 спринт  ⟲×0   │  │
│  │        │                │ ⚠️ Переносилась из Sprint 4 → 5 → 6             │  │
│  └────────┴────────────────┴─────────────────────────────────────────────────┘  │
│                                                                                 │
│  ЛЕГЕНДА: 🔄 смена статуса | 👤 смена исполнителя | 🏃 смена спринта | ⟲ реопен │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Задачи блока
- [x] 2.1 Парсер changelog с фильтрацией по периоду
- [ ] 2.2 Визуализация timeline изменений
- [x] 2.3 Агрегация метрик активности
- [ ] 2.4 Фильтры по типу изменений
- [ ] 2.5 Детальный drill-down по клику

---

## Блок 3: Time Distribution (Распределение времени)

### Цель
Понять, где задача "застряла" и на ком висела дольше всего.

### Метрики времени

#### 3.1 Время в статусах

> **Примечание**: Статусы берутся из реальных данных проекта, названия любые.
> Категория определяется через конфигурацию workflow (Блок 0).

```javascript
{
    key: "PROJ-123",
    timeInStatuses: {
        // Ключ — реальное название статуса из Jira (любое)
        "To Do": { totalDays: 5, category: "queue", entries: [...] },
        "In Progress": { totalDays: 8, category: "work", entries: [...] },
        "На ревью": { totalDays: 12, category: "review", entries: [...] },  // ⚠️ Bottleneck!
        "Готово": { totalDays: 0, category: "done" }
    },
    // Агрегация по категориям
    timeInCategories: {
        "queue": 5,
        "work": 8,
        "review": 12,  // ⚠️ Longest!
        "done": 0
    },
    longestStatus: "На ревью",
    longestCategory: "review",
    avgTimePerStatus: 6.25
}
```

#### 3.2 Время на исполнителях
```javascript
{
    key: "PROJ-123", 
    timeOnAssignees: {
        "ivanov": { totalDays: 10, periods: [...] },
        "petrov": { totalDays: 5, periods: [...] },
        "unassigned": { totalDays: 3, periods: [...] }  // ⚠️ Проблема!
    }
}
```

#### 3.3 Lead Time & Cycle Time

> **Зависит от конфигурации workflow (Блок 0)**

| Метрика | Формула | Требуемые категории |
|---------|---------|---------------------|
| **Lead Time** | От создания до первого статуса категории `done` | `done` (или просто updated - created) |
| **Cycle Time** | От первого статуса `work` до первого статуса `done` | `work` + `done` |
| **Wait Time** | Lead Time - Cycle Time | `work` + `done` |
| **Review Time** | Время в статусах категории `review` | `review` |
| **Testing Time** | Время в статусах категории `testing` | `testing` |

Если категория не настроена — соответствующая метрика показывает "—".

### UI: Heatmap времени

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ ⏱️ РАСПРЕДЕЛЕНИЕ ВРЕМЕНИ                              [По категориям ▼]        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ПО СТАТУСАМ (реальные названия из проекта):                                   │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │ Открыт       ████████░░░░░░░░░░░░░░░░░░░░░░░░░░░  18%  (avg 2.1 дня)   │  │
│  │ В работе     ██████████████████░░░░░░░░░░░░░░░░░░  35%  (avg 4.2 дня)   │  │
│  │ На ревью     █████████████████████████████░░░░░░░  52%  (avg 6.1 дня)⚠️│  │
│  │ Тестирование ████████████░░░░░░░░░░░░░░░░░░░░░░░░  22%  (avg 2.6 дня)   │  │
│  │ Закрыт       ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░   0%                  │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ПО КАТЕГОРИЯМ (агрегация, если настроен workflow):                            │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │ 📥 queue     ████████░░░░░░░░░░░░░░░░░░░░░░░░░░░  18%  (2 статуса)     │  │
│  │ 📋 work      ██████████████████░░░░░░░░░░░░░░░░░░  35%  (1 статус)      │  │
│  │ 🔍 review    █████████████████████████████░░░░░░░  52%  ⚠️ BOTTLENECK  │  │
│  │ 🧪 testing   ████████████░░░░░░░░░░░░░░░░░░░░░░░░  22%  (1 статус)      │  │
│  │ ✅ done      ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░   0%                  │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ПО ИСПОЛНИТЕЛЯМ (время владения задачами):                                    │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │ Иванов И.    ██████████████████████░░░░░░░░░░░░░░  42%  (15 задач)      │  │
│  │ Петров П.    █████████████░░░░░░░░░░░░░░░░░░░░░░░  25%  (8 задач)       │  │
│  │ Сидоров С.   ████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░  15%  (12 задач)      │  │
│  │ Не назначен  █████████░░░░░░░░░░░░░░░░░░░░░░░░░░░  18%  (22 задачи) ⚠️  │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  МЕТРИКИ ВРЕМЕНИ:                                                              │
│  ┌────────────────┬────────────────┬────────────────┬────────────────────────┐ │
│  │ Lead Time (avg)│ Cycle Time(avg)│ Wait Time (avg)│ % времени в ожидании   │ │
│  │    14.5 дней   │    8.2 дней    │    6.3 дней    │       43% ⚠️           │ │
│  └────────────────┴────────────────┴────────────────┴────────────────────────┘ │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Задачи блока
- [x] 3.1 Калькулятор времени в статусах (с учётом периода)
- [x] 3.2 Калькулятор времени на исполнителях
- [x] 3.3 Расчёт Lead/Cycle/Wait Time
- [x] 3.4 Heatmap визуализация
- [ ] 3.5 Выделение аномалий (>2σ от среднего)

---

## Блок 4: Development Cycle Analysis (Цикл разработки)

### Источник данных
`GET /rest/dev-status/1.0/issue/detail?issueId={id}&applicationType=stash&dataType=repository`

### Что отслеживаем

#### 4.1 Commits & Pull Requests
```javascript
{
    key: "PROJ-123",
    devActivity: {
        commits: [
            { author: "ivanov", date: "2024-01-15", message: "PROJ-123 feat: login form" },
            { author: "ivanov", date: "2024-01-16", message: "PROJ-123 fix: validation" }
        ],
        pullRequests: [
            {
                id: "PR-456",
                author: "ivanov",
                status: "MERGED",
                created: "2024-01-16",
                merged: "2024-01-18",
                reviewers: ["petrov", "sidorov"],
                approvals: [
                    { by: "petrov", at: "2024-01-17" },
                    { by: "sidorov", at: "2024-01-18" }
                ],
                comments: 5,
                iterations: 2  // Сколько раз возвращали на доработку
            }
        ]
    }
}
```

#### 4.2 Ключевые метрики разработки

| Метрика | Описание | Что показывает |
|---------|----------|----------------|
| **PR Cycle Time** | Время от создания PR до merge | Скорость code review |
| **Review Iterations** | Кол-во правок после ревью | Качество кода |
| **Reviewer Load** | Сколько PR ревьюит каждый | Распределение нагрузки |
| **Approval Rate** | % PR одобренных с первого раза | Качество работы разработчика |
| **Code Churn** | Количество изменённых строк | Сложность задачи |

#### 4.3 Паттерн "Пинг-понг" (возвраты)

> Определяется по переходам между категориями `review` ↔ `work`

```
[review] → [work] → [review] → [work] → [review] → [done]
    ↑          ↓         ↑          ↓
  PR Created  Declined  Updated   Approved
```

**Детекция**: считаем количество переходов `review` → `work` (возвраты на доработку).

**Индикатор качества**: если задача возвращалась из review >2 раз — проблема с:
- Требованиями (непонятно что делать)
- Качеством кода разработчика
- Придирчивостью ревьюера

> Если категория `review` не настроена — этот анализ недоступен.

### UI: Development Insights

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 💻 АНАЛИЗ ЦИКЛА РАЗРАБОТКИ                                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ОБЗОР PR ЗА ПЕРИОД:                                                           │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │ Всего PR: 45    Merged: 38    Open: 5    Declined: 2                     │  │
│  │ Avg PR Cycle Time: 2.3 дня    Avg Iterations: 1.4                        │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  НАГРУЗКА НА РЕВЬЮЕРОВ:                                                        │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │ Иванов И.    ████████████████████████████  28 reviews  (avg 1.1 дня)    │  │
│  │ Петров П.    ████████████████░░░░░░░░░░░░  16 reviews  (avg 2.3 дня)    │  │
│  │ Сидоров С.   ████████░░░░░░░░░░░░░░░░░░░░   8 reviews  (avg 3.1 дня)⚠️  │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  КАЧЕСТВО ПО РАЗРАБОТЧИКАМ (First-time Approval Rate):                         │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │ Козлов К.    ████████████████████████████░░  92%  ✓ Отлично             │  │
│  │ Новиков Н.   ████████████████████░░░░░░░░░░  68%  ⚠️ Внимание           │  │
│  │ Морозов М.   ████████████░░░░░░░░░░░░░░░░░░  45%  🔴 Проблема           │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ⚠️ ЗАДАЧИ С МНОЖЕСТВЕННЫМИ ВОЗВРАТАМИ (>2 iterations):                        │
│  ┌────────┬──────────────────┬───────────┬───────────┬───────────────────────┐ │
│  │ Задача │ PR               │ Iterations│ Автор     │ Причина               │ │
│  ├────────┼──────────────────┼───────────┼───────────┼───────────────────────┤ │
│  │PROJ-89 │ PR-567           │     4     │ Морозов   │ Code style, bugs      │ │
│  │PROJ-92 │ PR-589           │     3     │ Новиков   │ Missing tests         │ │
│  └────────┴──────────────────┴───────────┴───────────┴───────────────────────┘ │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Задачи блока
- [x] 4.1 Интеграция с Bitbucket/GitHub API через dev-status
- [x] 4.2 Парсер PR и коммитов
- [x] 4.3 Расчёт PR Cycle Time и iterations
- [x] 4.4 Матрица "автор-ревьюер"
- [x] 4.5 Выявление паттерна "пинг-понг"
- [x] 4.6 First-time Approval Rate по разработчикам

---

## Блок 5: Workflow Bottlenecks (Узкие места)

### Цель
Автоматическое выявление системных проблем в процессе.

### Паттерны проблем для выявления

> **Все паттерны используют категории статусов, а не конкретные названия.**
> Если нужная категория не настроена — паттерн не анализируется.

#### 5.1 Очередь на Review (категория `review`)
```
Требует: категория "review" настроена

Признаки:
- Avg время в статусах категории "review" > порога (настраиваемо)
- Накопление задач в этих статусах
- Перекос нагрузки между ревьюерами

Причины:
- Мало ревьюеров
- Ревьюеры перегружены своими задачами
- Слишком большие PR

Рекомендация: 
→ Выделить время на ревью / добавить ревьюеров
```

#### 5.2 Задачи-бумеранги (reopens)
```
Требует: категория "done" настроена

Признаки:
- Возврат из категории "done" в любую другую (reopen)
- Возврат из "testing" в "work" (если настроены)
- >2 итераций PR

Причины:
- Плохие требования
- Недостаточное тестирование
- Спешка

Рекомендация:
→ Улучшить Definition of Done / добавить чек-листы
```

#### 5.3 Задачи-путешественники
```
Требует: ничего (анализ спринтов и assignee)

Признаки:
- Задача меняла спринт >2 раз
- Находится в категории "work" >10 дней (или просто >10 дней в активных статусах)
- Многократная смена assignee

Причины:
- Неправильная оценка
- Блокировки
- Непонятные требования

Рекомендация:
→ Разбить задачу / уточнить требования
```

#### 5.4 "Брошенные" задачи
```
Требует: категория "done" (опционально "waiting")

Признаки:
- Нет активности >7 дней
- Статус НЕ в категориях "done" и "waiting"
- Есть assignee

Причины:
- Забыли
- Заблокированы неявно
- Ждут чего-то

Рекомендация:
→ Срочно уточнить статус
```

#### 5.5 Перегруз исполнителей (WIP)
```
Требует: категория "work" (или считаем все не-done статусы)

Признаки:
- >5 задач в статусах категории "work" одновременно у одного человека
- WIP > capacity
- Постоянные переключения между задачами

Причины:
- Плохое планирование
- Неумение говорить "нет"
- Внешние запросы

Рекомендация:
→ Ввести WIP-лимиты
```

#### 5.6 Застревание в Testing (категория `testing`)
```
Требует: категория "testing" настроена

Признаки:
- Avg время в статусах категории "testing" > порога
- Много возвратов testing → work

Причины:
- Мало тестировщиков
- Плохое качество кода
- Сложная функциональность

Рекомендация:
→ Автотесты / парное тестирование
```

### UI: Bottleneck Dashboard

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 🔄 УЗКИЕ МЕСТА ПРОЦЕССА                               [⚙️ Настроить workflow]   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ВЫЯВЛЕННЫЕ ПРОБЛЕМЫ:                                                          │
│                                                                                 │
│  🔴 КРИТИЧНО (требует немедленного внимания)                                   │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │ ⏳ Очередь [review]: 12 задач ждут >3 дней                               │  │
│  │    → Ревьюер Сидоров перегружен (18 задач на ревью)                      │  │
│  │    Статусы: "На ревью", "Code Review"                                    │  │
│  │    Действие: [Перераспределить] [Подробнее]                              │  │
│  ├──────────────────────────────────────────────────────────────────────────┤  │
│  │ 🔄 Задачи-бумеранги: 5 задач вернулись из [done]                         │  │
│  │    → PROJ-45, PROJ-67, PROJ-89, PROJ-92, PROJ-101                        │  │
│  │    Действие: [Анализ причин] [Подробнее]                                 │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  🟠 ВНИМАНИЕ (следует обратить внимание)                                       │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │ 🏃 Задачи-путешественники: 8 задач сменили спринт >2 раз                 │  │
│  │ 👻 "Брошенные" задачи: 3 задачи без активности >7 дней                   │  │
│  │ 📈 Перегруз WIP: Иванов — 7 задач в [work] (лимит: 5)                    │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ⚪ НЕДОСТУПНЫЕ МЕТРИКИ (настройте workflow)                                   │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │ ⚠️ Cycle Time: не настроена категория "work"                             │  │
│  │ ⚠️ Testing bottleneck: не настроена категория "testing"                  │  │
│  │    [⚙️ Настроить workflow]                                               │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  🟢 ПОЗИТИВНЫЕ ТРЕНДЫ                                                          │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │ ✓ Lead Time улучшился на 15% по сравнению с прошлым периодом             │  │
│  │ ✓ Количество reopens снизилось с 12% до 8%                               │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Задачи блока
- [x] 5.1 Детектор очереди на Code Review
- [x] 5.2 Детектор задач-бумерангов
- [x] 5.3 Детектор задач-путешественников
- [x] 5.4 Детектор "брошенных" задач
- [x] 5.5 Детектор перегруза WIP
- [x] 5.6 Агрегатор проблем с приоритизацией
- [ ] 5.7 Рекомендации по решению

---

## Блок 6: Team Performance Insights (Метрики команды)

### Цель
Объективные метрики работы участников без "пальцем показывания".

### Метрики по участникам

#### 6.1 Velocity & Throughput
```javascript
{
    user: "ivanov",
    metrics: {
        issuesClosed: 15,           // Закрыто задач
        hoursLogged: 120,           // Залогировано часов
        avgCycleTime: 3.2,          // Среднее время на задачу (дни)
        throughput: 0.75            // Задач/день
    }
}
```

#### 6.2 Quality Metrics
```javascript
{
    user: "ivanov",
    quality: {
        reopenRate: 0.05,           // % задач вернувшихся после закрытия
        firstTimeApproval: 0.85,    // % PR одобренных с первого раза
        avgPRIterations: 1.3,       // Среднее кол-во итераций PR
        bugEscapeRate: 0.02         // % багов пропущенных на прод
    }
}
```

#### 6.3 Collaboration Metrics
```javascript
{
    user: "ivanov",
    collaboration: {
        reviewsDone: 28,            // Сколько PR отревьюил
        avgReviewTime: 1.1,         // Среднее время на ревью (дни)
        helpedOthers: 5,            // Задачи где помогал (парное программирование)
        blockedOthers: 0            // Задачи где заблокировал других (негатив)
    }
}
```

### UI: Team Dashboard

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 👥 МЕТРИКИ КОМАНДЫ                                                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Период: 01.12.2024 — 31.12.2024                     [Сравнить с прошлым ▼]    │
│                                                                                 │
│  ┌────────────┬─────────┬─────────┬───────────┬───────────┬─────────┬────────┐ │
│  │ Участник   │ Закрыто │ Часы    │ Cycle Time│ 1st Appr% │ Reviews │ Reopen%│ │
│  ├────────────┼─────────┼─────────┼───────────┼───────────┼─────────┼────────┤ │
│  │ Иванов И.  │   15    │  120h   │  3.2 дня  │    85%    │   28    │   5%   │ │
│  │ Петров П.  │   12    │   96h   │  4.1 дня  │    72%    │   16    │   8%   │ │
│  │ Сидоров С. │    8    │   80h   │  5.5 дня  │    90%    │    8    │   0%   │ │
│  │ Козлов К.  │   18    │  140h   │  2.8 дня  │    92%    │   22    │   3%   │ │
│  │ ────────── │ ─────── │ ─────── │ ───────── │ ───────── │ ─────── │ ────── │ │
│  │ ВСЕГО/AVG  │   53    │  436h   │  3.9 дня  │    85%    │   74    │   4%   │ │
│  └────────────┴─────────┴─────────┴───────────┴───────────┴─────────┴────────┘ │
│                                                                                 │
│  RADAR CHART (выбранный участник):                      [Иванов И. ▼]          │
│                                                                                 │
│                        Скорость                                                │
│                           ●                                                    │
│                          /│\                                                   │
│                         / │ \                                                  │
│              Качество ●───┼───● Объём                                         │
│                         \ │ /                                                  │
│                          \│/                                                   │
│                           ●                                                    │
│                     Коллаборация                                              │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Задачи блока
- [x] 6.1 Расчёт velocity и throughput
- [ ] 6.2 Расчёт quality метрик
- [ ] 6.3 Расчёт collaboration метрик
- [ ] 6.4 Сравнение с прошлым периодом
- [ ] 6.5 Radar chart индивидуальных метрик
- [ ] 6.6 Сортировка и фильтрация таблицы

---

## Блок 7: Risk Indicators (Индикаторы рисков)

### Автоматическое выявление рисковых ситуаций

#### 7.1 Карточка рисков задачи
```javascript
{
    key: "PROJ-123",
    riskScore: 78,  // 0-100
    riskFactors: [
        { type: "age", score: 30, message: "Задача создана 45 дней назад, не закрыта" },
        { type: "sprint_changes", score: 20, message: "Переносилась 3 раза между спринтами" },
        { type: "assignee_changes", score: 15, message: "Менялся исполнитель 4 раза" },
        { type: "no_progress", score: 25, message: "Нет активности 10 дней" }
    ]
}
```

#### 7.2 Типы рисков

| Риск | Порог | Вес | Требует категорию | Описание |
|------|-------|-----|-------------------|----------|
| **Возраст задачи** | >30 дней | 30 | — | Старые незакрытые задачи |
| **Перенос спринтов** | >2 раза | 20 | — | Задачи-путешественники |
| **Смена исполнителя** | >3 раза | 15 | — | "Футбол" задачами |
| **Нет активности** | >7 дней | 25 | `done` (опц.) | Забытые задачи |
| **Много reopens** | >1 раз | 20 | `done` | Проблемы с качеством |
| **Долгий Review** | >5 дней | 15 | `review` | Блокировка ревью |
| **Долгий Testing** | >3 дней | 15 | `testing` | Застревание в тестировании |
| **Много PR итераций** | >3 раза | 20 | — | Проблемы с кодом |
| **Высокий приоритет** | Critical | 10 | — | Критичные задачи |

> Если требуемая категория не настроена — соответствующий риск не учитывается в score.

### UI: Risk Matrix

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ ⚠️ МАТРИЦА РИСКОВ                                                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  РАСПРЕДЕЛЕНИЕ ПО УРОВНЮ РИСКА:                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │ 🔴 Критический (>80):    3 задачи   ████░░░░░░░░░░░░░░░░░░░░░░░░░░ 6%   │  │
│  │ 🟠 Высокий (60-80):      8 задач    ████████████░░░░░░░░░░░░░░░░░░ 16%  │  │
│  │ 🟡 Средний (40-60):     15 задач    ████████████████████████░░░░░░ 30%  │  │
│  │ 🟢 Низкий (<40):        24 задачи   █████████████████████████████ 48%   │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  🔴 КРИТИЧЕСКИЕ РИСКИ (требуют немедленного внимания):                         │
│  ┌────────┬────────────────┬───────┬────────────────────────────────────────┐  │
│  │ Задача │ Summary        │ Score │ Факторы риска                          │  │
│  ├────────┼────────────────┼───────┼────────────────────────────────────────┤  │
│  │PROJ-45 │ Интеграция API │  92   │ 🕐 60 дней, 🔄 4 спринта, 👻 15 дней  │  │
│  │PROJ-23 │ Auth module    │  85   │ 🔄 5 смен assignee, ⟲ 2 reopens       │  │
│  │PROJ-78 │ Payment bug    │  81   │ 🔥 Critical, 🕐 30 дней, 👻 8 дней    │  │
│  └────────┴────────────────┴───────┴────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Задачи блока
- [x] 7.1 Калькулятор risk score
- [x] 7.2 Конфигурация весов рисков
- [x] 7.3 Визуализация risk matrix
- [ ] 7.4 Drill-down по факторам риска
- [ ] 7.5 Алерты при появлении критических рисков

---

## Блок 8: Trend Analysis (Анализ трендов)

### Цель
Сравнить текущий период с прошлым, увидеть динамику.

### Метрики для отслеживания трендов

```javascript
{
    period: "2024-12",
    previousPeriod: "2024-11",
    trends: {
        avgCycleTime: { current: 4.2, previous: 5.1, change: -18, trend: "improving" },
        avgLeadTime: { current: 8.5, previous: 9.2, change: -8, trend: "improving" },
        reopenRate: { current: 0.08, previous: 0.12, change: -33, trend: "improving" },
        throughput: { current: 2.3, previous: 2.1, change: +10, trend: "improving" },
        prCycleTime: { current: 2.1, previous: 1.8, change: +17, trend: "declining" },
        sprintCarryover: { current: 0.15, previous: 0.10, change: +50, trend: "declining" }
    }
}
```

### UI: Trend Dashboard

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 📈 ТРЕНДЫ И ДИНАМИКА                                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Сравнение: Декабрь 2024 vs Ноябрь 2024                                        │
│                                                                                 │
│  КЛЮЧЕВЫЕ ПОКАЗАТЕЛИ:                                                          │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                          │  │
│  │  Cycle Time      Lead Time       Reopen Rate     Throughput              │  │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐           │  │
│  │  │  4.2 д   │    │  8.5 д   │    │   8%     │    │ 2.3/день │           │  │
│  │  │  ↓ 18%   │    │  ↓ 8%    │    │  ↓ 33%   │    │  ↑ 10%   │           │  │
│  │  │   🟢     │    │   🟢     │    │   🟢     │    │   🟢     │           │  │
│  │  └──────────┘    └──────────┘    └──────────┘    └──────────┘           │  │
│  │                                                                          │  │
│  │  PR Cycle Time   Sprint Carry    WIP avg         Review Queue            │  │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐           │  │
│  │  │  2.1 д   │    │   15%    │    │   3.2    │    │   5.1    │           │  │
│  │  │  ↑ 17%   │    │  ↑ 50%   │    │  ↓ 12%   │    │  ↑ 25%   │           │  │
│  │  │   🟠     │    │   🔴     │    │   🟢     │    │   🟠     │           │  │
│  │  └──────────┘    └──────────┘    └──────────┘    └──────────┘           │  │
│  │                                                                          │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ГРАФИКИ ЗА 6 МЕСЯЦЕВ:                                                         │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │  Cycle Time                                                              │  │
│  │  6.0 ─┐                                                                  │  │
│  │  5.0 ─┤    ●────●                                                        │  │
│  │  4.0 ─┤              ╲────●────●                                         │  │
│  │  3.0 ─┤                              ╲────●                               │  │
│  │  2.0 ─┼───────────────────────────────────────                            │  │
│  │       Jul   Aug   Sep   Oct   Nov   Dec                                  │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Задачи блока
- [ ] 8.1 Хранение исторических данных (localStorage/IndexedDB)
- [ ] 8.2 Расчёт изменений между периодами
- [ ] 8.3 Визуализация трендов (стрелки, цвета)
- [ ] 8.4 Линейные графики за N периодов
- [ ] 8.5 Алерты при ухудшении метрик

---

## Технические детали

### API Endpoints

```javascript
// 1. Поиск задач по JQL
POST /rest/api/2/search
{
    jql: "project = PROJ AND updated >= '2024-12-01' AND updated <= '2024-12-31'",
    fields: ["summary", "status", "assignee", "created", "updated", "priority", "issuetype", "resolution"],
    expand: ["changelog"],
    maxResults: 100,
    startAt: 0
}

// 2. Детали задачи с changelog (если не expand в search)
GET /rest/api/2/issue/{key}?expand=changelog

// 3. Worklogs задачи
GET /rest/api/2/issue/{key}/worklog

// 4. Development status (commits, PRs) — ✅ ДОСТУПНО
GET /rest/dev-status/1.0/issue/detail?issueId={id}&applicationType=stash&dataType=repository

// 5. Получить метаданные полей проекта (для определения customfield_*)
GET /rest/api/2/field
```

### Кастомные поля

Проекты используют разные кастомные поля. Система поддерживает их настройку.

#### Поддерживаемые кастомные поля

| Поле | Тип | ID (пример) | Для чего используется |
|------|-----|-------------|----------------------|
| **Story Points** | number | `customfield_10004` | Velocity, оценка сложности |
| **Epic Link** | string | `customfield_10008` | Группировка по эпикам |
| **Sprint** | array | `customfield_10007` | История спринтов |
| **Components** | array | встроенное | Группировка по компонентам |
| **Labels** | array | встроенное | Теги, метки |
| **Fix Version** | array | встроенное | Релизы |

#### Авто-определение полей

```javascript
// При первой загрузке проекта — запрос метаданных полей
GET /rest/api/2/field

// Ищем известные поля по имени/схеме
function detectCustomFields(fields) {
    var detected = {};
    
    fields.forEach(function(field) {
        var name = (field.name || "").toLowerCase();
        var id = field.id;
        
        if (name.includes("story point") || name.includes("стори поинт")) {
            detected.storyPoints = id;
        }
        if (name.includes("epic link") || name.includes("эпик")) {
            detected.epicLink = id;
        }
        if (name.includes("sprint") || name.includes("спринт")) {
            detected.sprint = id;
        }
    });
    
    return detected;
}
```

#### UI: Настройка кастомных полей

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ ⚙️ НАСТРОЙКА КАСТОМНЫХ ПОЛЕЙ                                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Проект: PROJ                                    [🔍 Определить автоматически]  │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ Story Points:  [customfield_10004 ▼]  ← автоопределено                 │   │
│  │ Epic Link:     [customfield_10008 ▼]  ← автоопределено                 │   │
│  │ Sprint:        [customfield_10007 ▼]  ← автоопределено                 │   │
│  │ Team:          [не задано        ▼]  ← опционально                     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  💡 Поля Components, Labels, Fix Version — встроенные, настройка не требуется. │
│                                                                                 │
│                                                    [Сохранить] [Отмена]         │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### Использование в аналитике

```javascript
// Добавляем кастомные поля в запрос
var customFields = getCustomFieldsConfig();
var fields = [
    "summary", "status", "assignee", "created", "updated", 
    "priority", "issuetype", "resolution", "components", "labels", "fixVersions"
];

// Добавляем настроенные кастомные поля
if (customFields.storyPoints) fields.push(customFields.storyPoints);
if (customFields.epicLink) fields.push(customFields.epicLink);
if (customFields.sprint) fields.push(customFields.sprint);

// В результатах
{
    key: "PROJ-123",
    storyPoints: 5,                    // из customfield_10004
    epicKey: "PROJ-100",               // из customfield_10008
    sprintHistory: ["Sprint 5", "Sprint 6"],  // из customfield_10007
    components: ["Backend", "API"],    // встроенное
    labels: ["urgent", "tech-debt"]    // встроенное
}
```

#### Метрики с использованием кастомных полей

| Метрика | Требует поле | Описание |
|---------|--------------|----------|
| **Velocity (SP)** | storyPoints | Story Points закрытых задач за период |
| **Avg SP per issue** | storyPoints | Средний размер задачи в SP |
| **Epic progress** | epicLink | % закрытых задач в эпике |
| **Component distribution** | components | Распределение задач по компонентам |
| **Label analysis** | labels | Анализ по меткам (tech-debt, bug, etc.) |

### Структура данных

```javascript
// Собранные данные для аналитики
var analyticsData = {
    period: { start: "2024-12-01", end: "2024-12-31" },
    issues: {
        "PROJ-123": {
            key: "PROJ-123",
            summary: "...",
            status: "Done",
            assignee: { id: "...", name: "Иванов И." },
            created: "2024-11-15",
            resolved: "2024-12-20",
            
            // Кастомные поля (если настроены)
            storyPoints: 5,                         // из customfield_*
            epicKey: "PROJ-100",                    // из customfield_*
            components: ["Backend", "API"],         // встроенное
            labels: ["urgent"],                     // встроенное
            fixVersions: ["v2.1.0"],                // встроенное
            
            // Из changelog
            changelog: {
                statusChanges: [...],
                assigneeChanges: [...],
                sprintChanges: [...]
            },
            
            // Рассчитанные метрики
            metrics: {
                leadTime: 35,  // дней
                cycleTime: 12, // дней
                timeInStatuses: {...},
                timeOnAssignees: {...}
            },
            
            // Dev данные
            devActivity: {
                commits: [...],
                pullRequests: [...]
            },
            
            // Risk score
            riskScore: 45,
            riskFactors: [...]
        }
    },
    
    // Агрегированные метрики
    aggregated: {
        avgCycleTime: 4.2,
        avgLeadTime: 8.5,
        totalIssues: 87,
        closedIssues: 53,
        ...
    }
};
```

### Структура файлов

```
ujg-project-analytics.js    — основная логика виджета
ujg-project-analytics.css   — стили
```

### Константы

```javascript
var CONFIG = {
    MAX_PERIOD_DAYS: 365,      // Максимальный период для анализа — 1 год
    DEFAULT_PERIOD_DAYS: 30,   // Период по умолчанию — месяц
    version: "1.0.0"
};
```

### Настройки (localStorage)

```javascript
// Основные настройки виджета
// Ключ: "ujg_project_analytics"
{
    jqlFilter: "project = PROJ",
    periodStart: "2024-12-01",
    periodEnd: "2024-12-31",
    
    // Веса рисков (можно переопределить через UI настроек)
    riskWeights: {
        age: 30,               // DEFAULT: 30
        sprintChanges: 20,     // DEFAULT: 20
        assigneeChanges: 15,   // DEFAULT: 15
        noProgress: 25,        // DEFAULT: 25
        reopens: 20,           // DEFAULT: 20
        longReview: 15,        // DEFAULT: 15
        longTesting: 15,       // DEFAULT: 15
        prIterations: 20       // DEFAULT: 20
    },
    
    // Пороговые значения (можно переопределить через UI настроек)
    thresholds: {
        ageRisk: 30,           // DEFAULT: 30 дней — задача считается "старой"
        noProgressRisk: 7,     // DEFAULT: 7 дней — нет активности
        longReviewRisk: 5,     // DEFAULT: 5 дней — долгий review
        longTestingRisk: 3,    // DEFAULT: 3 дня — долгий testing
        prIterationsRisk: 3,   // DEFAULT: 3 раза — много возвратов PR
        wipLimit: 5,           // DEFAULT: 5 задач — WIP лимит на человека
        sprintChangesRisk: 2,  // DEFAULT: 2 раза — задача-путешественник
        assigneeChangesRisk: 3 // DEFAULT: 3 раза — "футбол" задачей
    },
    
    // Кастомные поля (настраиваются под проект)
    customFields: {
        storyPoints: null,     // например "customfield_10004"
        components: true,      // встроенное поле
        labels: true,          // встроенное поле
        epicLink: null,        // например "customfield_10008"
        sprint: null           // например "customfield_10007"
    }
}
```

### Дефолтные значения (константы)

```javascript
var DEFAULT_THRESHOLDS = {
    ageRisk: 30,
    noProgressRisk: 7,
    longReviewRisk: 5,
    longTestingRisk: 3,
    prIterationsRisk: 3,
    wipLimit: 5,
    sprintChangesRisk: 2,
    assigneeChangesRisk: 3
};

var DEFAULT_RISK_WEIGHTS = {
    age: 30,
    sprintChanges: 20,
    assigneeChanges: 15,
    noProgress: 25,
    reopens: 20,
    longReview: 15,
    longTesting: 15,
    prIterations: 20
};

// При загрузке: merge с дефолтами
function getThresholds() {
    var saved = loadSettings().thresholds || {};
    return Object.assign({}, DEFAULT_THRESHOLDS, saved);
}
```

// Конфигурация workflow для каждого проекта
// Ключ: "ujg_pa_workflow_{projectKey}" (например "ujg_pa_workflow_PROJ")
{
    projectKey: "PROJ",
    lastUpdated: "2024-12-30T10:00:00",
    
    // Все статусы, встреченные в проекте
    allStatuses: ["To Do", "In Progress", "Code Review", "QA", "Done", "Blocked"],
    
    // Маппинг: статус → категории (массив, т.к. статус может быть в нескольких)
    statusCategories: {
        "To Do": ["queue"],
        "In Progress": ["work"],
        "Code Review": ["review"],
        "QA": ["testing"],
        "Done": ["done"],
        "Blocked": ["waiting"]
    },
    
    // Обратный индекс (генерируется автоматически)
    categoryStatuses: {
        "queue": ["To Do"],
        "work": ["In Progress"],
        "review": ["Code Review"],
        "testing": ["QA"],
        "waiting": ["Blocked"],
        "done": ["Done"]
    },
    
    // Флаг: была ли ручная настройка (или всё auto-suggest)
    isManuallyConfigured: false
}
```

### Доступные категории

```javascript
var STATUS_CATEGORIES = {
    queue: { 
        name: "Очередь", 
        icon: "📥", 
        description: "Задача ждёт начала работы",
        color: "#e0e0e0"
    },
    work: { 
        name: "В работе", 
        icon: "📋", 
        description: "Активная разработка",
        color: "#4a90d9"
    },
    review: { 
        name: "Ревью", 
        icon: "🔍", 
        description: "Code Review, проверка",
        color: "#f5a623"
    },
    testing: { 
        name: "Тестирование", 
        icon: "🧪", 
        description: "QA, тестирование",
        color: "#7ed321"
    },
    waiting: { 
        name: "Ожидание", 
        icon: "⏸️", 
        description: "Blocked, On Hold",
        color: "#d0021b"
    },
    done: { 
        name: "Завершено", 
        icon: "✅", 
        description: "Закрыто, готово",
        color: "#417505"
    }
};
```

---

## План разработки (MVP)

### Фаза 1: Инфраструктура
1. [ ] Создать базовую структуру виджета (AMD module)
2. [ ] Реализовать модальное окно прогресса загрузки
3. [ ] Реализовать API tracker
4. [ ] Базовый UI с панелью фильтров (период до 365 дней)
5. [ ] **Workflow Configuration**: UI для настройки категорий статусов
6. [ ] **Auto-suggest**: автоопределение категорий при первой загрузке
7. [ ] **Storage**: сохранение/загрузка конфигурации в localStorage
8. [ ] **Custom Fields**: UI настройки кастомных полей + автоопределение
9. [ ] **Settings UI**: редактирование пороговых значений (с дефолтами)

### Фаза 2: Сбор данных
10. [ ] Загрузка задач по JQL (с кастомными полями)
11. [ ] Загрузка changelog для каждой задачи
12. [ ] Парсер changelog с фильтрацией по периоду
13. [ ] Загрузка dev-status (commits, PRs)
14. [ ] Загрузка метаданных полей (`/rest/api/2/field`)

### Фаза 3: Базовая аналитика
15. [ ] Расчёт time in statuses (по категориям)
16. [ ] Расчёт time on assignees
17. [ ] Расчёт Lead/Cycle Time (с учётом категорий)
18. [ ] Таблица задач с активностью

### Фаза 4: Продвинутая аналитика
19. [ ] Детекторы узких мест (bottlenecks)
20. [ ] Калькулятор risk score (настраиваемые пороги)
21. [ ] Метрики команды
22. [ ] Анализ dev cycle (PR, commits)
23. [ ] Velocity по Story Points (если настроено)

### Фаза 5: Визуализация
24. [ ] Heatmap времени в статусах
25. [ ] Risk matrix
26. [ ] Team performance table
27. [ ] Trend charts
28. [ ] Группировка по Components/Epic (если настроено)

---

## Решённые вопросы

| # | Вопрос | Ответ |
|---|--------|-------|
| 1 | Доступ к `/rest/dev-status/` | ✅ Есть — включаем интеграцию с Bitbucket/GitHub |
| 2 | Какие статусы "рабочие"? | ✅ Решено через конфигурацию workflow (Блок 0) |
| 3 | Кастомные поля | ✅ Нужны — добавляем Story Points, Components и др. |
| 4 | Максимальный период | ✅ Год (365 дней) |
| 5 | Интеграция с Tempo | ❌ Не нужна |
| 6 | Пороговые значения | ✅ Дефолтные + возможность переопределить |

---

## Глоссарий

### Метрики

| Термин | Описание |
|--------|----------|
| **Lead Time** | Время от создания задачи до её закрытия |
| **Cycle Time** | Время от начала работы до завершения |
| **Wait Time** | Время ожидания (Lead Time - Cycle Time) |
| **Throughput** | Количество закрытых задач за единицу времени |
| **WIP** | Work In Progress — задачи в работе |
| **Risk Score** | Числовая оценка рисковости задачи (0-100) |
| **First-time Approval** | PR одобрен без возвратов на доработку |
| **Reopen Rate** | % задач, вернувшихся после закрытия |

### Категории статусов

| Категория | Код | Описание | Примеры статусов |
|-----------|-----|----------|------------------|
| Очередь | `queue` | Задача ждёт начала работы | To Do, Backlog, Open, Открыт |
| В работе | `work` | Активная разработка | In Progress, Development, В работе |
| Ревью | `review` | Code Review, проверка | Code Review, На ревью, Review |
| Тестирование | `testing` | QA, тестирование | QA, Testing, Тестирование |
| Ожидание | `waiting` | Заблокирована | Blocked, On Hold, Ожидает |
| Завершено | `done` | Задача закрыта | Done, Closed, Resolved, Готово |

> **Важно**: категории — это абстракция над конкретными статусами. 
> Каждый проект настраивает свой маппинг статусов на категории.
> Какие-то категории могут отсутствовать в проекте — это нормально.
