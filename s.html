<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ–ø—ã—Ç–æ–≤ - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #24292e;
            background-color: #f6f8fa;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }
        
        h1 {
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
            font-size: 2em;
            margin-bottom: 16px;
        }
        
        h2 {
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
            font-size: 1.5em;
            margin-top: 24px;
            margin-bottom: 16px;
        }
        
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 15px;
            background: #f6f8fa;
            border-radius: 6px;
        }
        
        .btn {
            padding: 8px 16px;
            border: 1px solid #d1d5da;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #f3f4f6;
            border-color: #959da5;
        }
        
        .btn-primary {
            background: #2da44e;
            color: white;
            border-color: #2da44e;
        }
        
        .btn-primary:hover {
            background: #2c974b;
        }
        
        .btn-danger {
            background: #cf222e;
            color: white;
            border-color: #cf222e;
        }
        
        .btn-danger:hover {
            background: #a40e26;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .table-wrapper {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 16px;
        }
        
        table th,
        table td {
            padding: 8px 13px;
            border: 1px solid #d0d7de;
            min-width: 80px;
        }
        
        table th {
            background-color: #f6f8fa;
            font-weight: 600;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        table tr:nth-child(even) {
            background-color: #f6f8fa;
        }
        
        table tr:hover {
            background-color: #f0f0f0;
        }
        
        .editable {
            cursor: pointer;
            position: relative;
        }
        
        .editable:hover {
            background-color: #fff8c5;
        }
        
        .editable input {
            width: 100%;
            border: 2px solid #0969da;
            padding: 4px;
            font-size: 14px;
        }
        
        .row-header {
            font-weight: 600;
            background-color: #f6f8fa !important;
        }
        
        .total-row {
            font-weight: bold;
            background-color: #dff6dd !important;
        }
        
        .section-header {
            font-weight: bold;
            background-color: #fff8c5 !important;
            text-align: center;
        }
        
        .comparison-panel {
            margin: 30px 0;
            padding: 20px;
            background: #f6f8fa;
            border-radius: 6px;
            border: 2px solid #d0d7de;
        }
        
        .comparison-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .comparison-controls label {
            font-weight: 600;
        }
        
        .comparison-controls select {
            padding: 8px;
            border: 1px solid #d1d5da;
            border-radius: 6px;
            font-size: 14px;
            min-width: 200px;
        }
        
        .comparison-result {
            margin-top: 20px;
        }
        
        .comparison-result table {
            max-width: 800px;
        }
        
        .positive-change {
            color: #2da44e;
            font-weight: 600;
        }
        
        .negative-change {
            color: #cf222e;
            font-weight: 600;
        }
        
        .add-remove-panel {
            margin: 20px 0;
            padding: 15px;
            background: #f6f8fa;
            border-radius: 6px;
        }
        
        .add-remove-panel input {
            padding: 8px;
            border: 1px solid #d1d5da;
            border-radius: 6px;
            margin-right: 10px;
            font-size: 14px;
        }
        
        code {
            background-color: rgba(175,184,193,0.2);
            padding: 0.2em 0.4em;
            border-radius: 6px;
            font-size: 85%;
        }
        
        .info-block {
            background: #dff6dd;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #2da44e;
        }
        
        .delete-btn {
            cursor: pointer;
            color: #cf222e;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        th:hover .delete-btn,
        tr:hover .delete-btn {
            opacity: 1;
        }
        
        .delete-btn:hover {
            background: #cf222e;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ–ø—ã—Ç–æ–≤ —Å –ø–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π —Ä–∞–∑–±–∏–≤–∫–æ–π</h1>
        
        <div class="info-block">
            <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-start;">
                <div>
                    <strong>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã:</strong>
                    <span onclick="editSystemParam('cpu')" style="cursor: pointer; padding: 2px 4px; margin-left: 10px; border-bottom: 1px dashed #0969da;" title="–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">
                        <strong id="cpu-value">24</strong> —è–¥—Ä–∞ CPU
                    </span> | 
                    <span onclick="editSystemParam('ram')" style="cursor: pointer; padding: 2px 4px; border-bottom: 1px dashed #0969da;" title="–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è">
                        <strong id="ram-value">79</strong> –ì–ë RAM
                    </span>
                </div>
                <div style="flex: 1; min-width: 300px; color: #666; font-size: 14px;">
                    <strong>üí° –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:</strong> –î–≤–∞–∂–¥—ã –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —è—á–µ–π–∫–µ —Ç–∞–±–ª–∏—Ü—ã. –ú–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: <code>50%</code> –∏–ª–∏ <code>100%</code>) - –æ–Ω–∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—é—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ —Å–∏—Å—Ç–µ–º—ã (–¥–ª—è —è–¥–µ—Ä - –æ—Ç 24, –¥–ª—è –ø–∞–º—è—Ç–∏ - –æ—Ç 79 –ì–ë)
                </div>
            </div>
        </div>
        
        <div class="toolbar">
            <button class="btn btn-primary" onclick="exportToCSV()">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV (Excel)</button>
            <button class="btn btn-primary" onclick="exportToMarkdown()">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Markdown</button>
            <button class="btn btn-primary" onclick="document.getElementById('csvFileInput').click()">üì§ –ò–º–ø–æ—Ä—Ç (CSV/TXT)</button>
            <input type="file" id="csvFileInput" accept=".csv,.txt,.tsv" onchange="importFromCSV(event)">
            <button class="btn" onclick="addExperiment()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ–ø—ã—Ç</button>
            <button class="btn" onclick="addService()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å</button>
            <button class="btn btn-danger" onclick="clearLocalStorage()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</button>
            <button class="btn btn-danger" onclick="resetTable()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
        
        <div class="table-wrapper">
            <table id="mainTable">
                <thead>
                    <tr id="headerRow">
                        <th>–ü–∞—Ä–∞–º–µ—Ç—Ä/–°–µ—Ä–≤–∏—Å (—è–¥—Ä–∞/–ì–ë)</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
        
        <h2>üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –æ–ø—ã—Ç–æ–≤</h2>
        <div class="comparison-panel">
            <div class="comparison-controls">
                <div>
                    <label>–û–ø—ã—Ç 1:</label>
                    <select id="experiment1Select" onchange="updateComparison()">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—ã—Ç --</option>
                    </select>
                </div>
                <div>
                    <label>–û–ø—ã—Ç 2:</label>
                    <select id="experiment2Select" onchange="updateComparison()">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—ã—Ç --</option>
                    </select>
                </div>
            </div>
            <div class="comparison-result" id="comparisonResult">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∞ –æ–ø—ã—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</p>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è LocalStorage
        const STORAGE_KEY_EXPERIMENTS = 'experiments_data';
        const STORAGE_KEY_TABLE = 'table_data';
        const STORAGE_KEY_SYSTEM = 'system_params';
        
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏—Å—Ç–µ–º—ã
        let systemParams = {
            cpu: 24,
            ram: 79
        };
        
        // –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        let experiments = [
            "–û–ø—ã—Ç 1: 1–ú —Ç–µ–≥–æ–≤", 
            "–û–ø—ã—Ç 2: 2–ú —Ç–µ–≥–æ–≤"
        ];
        
        let tableData = {
            "–£–°–õ–û–í–ò–Ø": { type: "section" },
            "–¢–µ–≥–æ–≤": ["1000000", "2000000"],
            "–ò–∑–º/—Å–µ–∫": ["2250", "2250"],
            "–ê–ª–∞—Ä/—Å–µ–∫": ["100", "200"],
            "UI": ["–≤–∫–ª", "–≤–∫–ª"],
            "–ò–¢–û–ì–û –Ø–î–†–ê": ["4.50", "7.80"],
            "–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨": ["32.50", "48.20"],
            "–°–ï–†–í–ò–°–´": { type: "section" },
            "service-core-01 (—è–¥—Ä–∞)": ["2.50", "4.80"],
            "service-core-01 (–ì–ë)": ["12.50", "18.20"],
            "service-data-01 (—è–¥—Ä–∞)": ["2.00", "3.00"],
            "service-data-01 (–ì–ë)": ["20.00", "30.00"]
        };

        // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ CSV/Excel
        function cleanCSVCell(raw) {
            if (raw === undefined || raw === null) return '';
            let val = String(raw).replace(/\u00A0/g, ' ').trim(); // —É–±–∏—Ä–∞–µ–º –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
            if (val.startsWith('="') && val.endsWith('"')) {
                val = val.slice(2, -1);
            } else if ((val.startsWith('"') && val.endsWith('"')) || (val.startsWith("'") && val.endsWith("'"))) {
                val = val.slice(1, -1);
            }
            if (val.startsWith('=')) {
                val = val.slice(1); // Excel –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∫–∞–∫ =123 –∏–ª–∏ =TEXT(...)
            }
            return val.trim();
        }

        function parseLocaleNumber(value) {
            if (value === undefined || value === null) return null;
            const normalized = String(value)
                .replace(/\u00A0/g, '')
                .replace(/\s/g, '')
                .replace(/,/g, '.');
            const num = parseFloat(normalized);
            return isNaN(num) ? null : num;
        }

        function convertPercentToAbsolute(value, rowName, colIdx, rowValues) {
            const match = String(value).match(/^(-?\d+(?:[.,]\d+)?)\s*%$/);
            if (!match) return null;

            const percentNum = parseFloat(match[1].replace(',', '.'));
            if (isNaN(percentNum)) return null;

            let base = 0;
            if (rowName.includes('(—è–¥—Ä–∞)') || rowName === '–ò–¢–û–ì–û –Ø–î–†–ê') {
                base = parseLocaleNumber(systemParams.cpu);
            } else if (rowName.includes('(–ì–ë)') || rowName === '–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨') {
                base = parseLocaleNumber(systemParams.ram);
            } else if (rowValues && rowValues.length > 0) {
                const firstVal = parseLocaleNumber(cleanCSVCell(rowValues[0]));
                if (firstVal !== null) base = firstVal;
            }

            const calculated = base > 0 ? (base * (percentNum / 100)) : (percentNum / 100);
            const isCountRow = ['–¢–µ–≥–æ–≤', '–ò–∑–º/—Å–µ–∫', '–ê–ª–∞—Ä/—Å–µ–∫'].includes(rowName);
            return isCountRow ? Math.round(calculated).toString() : calculated.toFixed(2);
        }

        function normalizeImportedValue(rawValue, rowName, colIdx, rowValues) {
            let val = cleanCSVCell(rawValue);
            if (!val) return '-';

            // –ü—Ä–æ—Ü–µ–Ω—Ç—ã, –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –≤ Excel (–Ω–∞–ø—Ä–∏–º–µ—Ä 50%)
            const percentValue = convertPercentToAbsolute(val, rowName, colIdx, rowValues);
            if (percentValue !== null) return percentValue;

            // –û–±—ã—á–Ω–æ–µ —á–∏—Å–ª–æ —Å —É—á–µ—Ç–æ–º –ª–æ–∫–∞–ª–∏
            const num = parseLocaleNumber(val);
            if (num !== null) {
                const isCountRow = ['–¢–µ–≥–æ–≤', '–ò–∑–º/—Å–µ–∫', '–ê–ª–∞—Ä/—Å–µ–∫'].includes(rowName);
                if (isCountRow) return Math.round(num).toString();
                return Number.isInteger(num) ? num.toString() : num.toFixed(2);
            }

            return val || '-';
        }
        
        function renderTable() {
            const headerRow = document.getElementById('headerRow');
            const tbody = document.getElementById('tableBody');
            
            // –û—á–∏—Å—Ç–∫–∞
            headerRow.innerHTML = '<th>–ü–∞—Ä–∞–º–µ—Ç—Ä/–°–µ—Ä–≤–∏—Å (—è–¥—Ä–∞/–ì–ë)</th>';
            tbody.innerHTML = '';
            
            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤
            experiments.forEach((exp, idx) => {
                const th = document.createElement('th');
                th.textContent = exp;
                th.innerHTML += ` <span class="delete-btn" onclick="deleteExperiment(${idx})" title="–£–¥–∞–ª–∏—Ç—å –æ–ø—ã—Ç">‚úñ</span>`;
                headerRow.appendChild(th);
            });
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Å—Ç—Ä–æ–∫
            const serviceGroups = {};
            const regularRows = [];
            
            Object.keys(tableData).forEach((rowName) => {
                if (tableData[rowName].type === 'section') {
                    regularRows.push({ name: rowName, type: 'section' });
                } else if (rowName.includes('–ò–¢–û–ì–û')) {
                    regularRows.push({ name: rowName, type: 'regular', isTotal: true });
                } else {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Å–µ—Ä–≤–∏—Å–æ–º
                    let baseName = rowName;
                    let metricType = null;
                    
                    if (rowName.includes(' (—è–¥—Ä–∞)')) {
                        baseName = rowName.replace(' (—è–¥—Ä–∞)', '');
                        metricType = 'cores';
                    } else if (rowName.includes(' (–ì–ë)')) {
                        baseName = rowName.replace(' (–ì–ë)', '');
                        metricType = 'memory';
                    }
                    
                    if (metricType) {
                        // –≠—Ç–æ —Å–µ—Ä–≤–∏—Å - –≥—Ä—É–ø–ø–∏—Ä—É–µ–º
                        if (!serviceGroups[baseName]) {
                            serviceGroups[baseName] = { cores: null, memory: null, firstSeen: regularRows.length };
                            regularRows.push({ name: baseName, type: 'service' });
                        }
                        serviceGroups[baseName][metricType] = rowName;
                    } else {
                        // –≠—Ç–æ –æ–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ (–¢–µ–≥–æ–≤, –ò–∑–º/—Å–µ–∫ –∏ —Ç.–¥.)
                        regularRows.push({ name: rowName, type: 'regular', isTotal: false });
                    }
                }
            });
            
            // –°—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            regularRows.forEach((row) => {
                const tr = document.createElement('tr');
                const th = document.createElement('th');
                th.className = 'row-header';
                
                if (row.type === 'section') {
                    th.textContent = row.name;
                    th.className = 'section-header';
                    th.colSpan = experiments.length + 1;
                    th.style.fontWeight = 'bold';
                    th.style.fontSize = '16px';
                    th.style.textAlign = 'center';
                    th.style.backgroundColor = '#fff8c5';
                    th.style.cursor = 'default'; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    tr.appendChild(th);
                    tbody.appendChild(tr);
                    return; // –í–∞–∂–Ω–æ! –ù–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è —Å–µ–∫—Ü–∏–π
                } else if (row.type === 'regular') {
                    const rowName = row.name;
                    th.textContent = rowName;
                    if (row.isTotal) {
                        th.className = 'row-header total-row';
                    }
                    // –ò—Ç–æ–≥–∏ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é, –æ–Ω–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                    if (!row.isTotal) {
                        th.innerHTML += ` <span class="delete-btn" onclick="deleteRow('${rowName}')" title="–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É">‚úñ</span>`;
                    }
                    tr.appendChild(th);
                    
                    experiments.forEach((exp, colIdx) => {
                        const td = document.createElement('td');
                        td.className = 'editable';
                        
                        if (row.isTotal) {
                            td.className += ' total-row service-cell'; // –î–æ–±–∞–≤–ª—è–µ–º service-cell –¥–ª—è —Å—Ç–∏–ª–µ–π
                            td.style.padding = '4px 8px'; // –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏
                            
                            const valStr = tableData[rowName][colIdx] || '-';
                            const val = parseFloat(valStr);
                            let percentHtml = '';
                            
                            if (!isNaN(val)) {
                                const total = rowName.includes('–Ø–î–†–ê') ? systemParams.cpu : systemParams.ram;
                                const percent = ((val / total) * 100).toFixed(1);
                                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–∞–≥—Ä—É–∑–∫–∏
                                let color = '#666';
                                if (percent > 90) color = '#cf222e'; // –ö—Ä–∞—Å–Ω—ã–π –µ—Å–ª–∏ > 90%
                                else if (percent > 70) color = '#9a6700'; // –û—Ä–∞–Ω–∂–µ–≤—ã–π –µ—Å–ª–∏ > 70%
                                
                                percentHtml = `<div style="font-size: 11px; color: ${color}; margin-top: 2px;">${percent}%</div>`;
                            } else {
                                percentHtml = `<div style="font-size: 11px; color: #999; margin-top: 2px;">-</div>`;
                            }
                            
                            td.innerHTML = `<div style="border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 2px;">${valStr}</div>
                                          ${percentHtml}`;
                                          
                            // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–µ
                            td.ondblclick = function(e) { 
                                // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ (–≤–µ—Ä—Ö–Ω—é—é —á–∞—Å—Ç—å)
                                makeEditable(this, rowName, colIdx, row.isTotal); 
                            };
                        } else {
                            // –û–±—ã—á–Ω—ã–µ —è—á–µ–π–∫–∏
                            td.textContent = tableData[rowName][colIdx] || '-';
                            td.ondblclick = function() { makeEditable(this, rowName, colIdx, row.isTotal); };
                        }
                        
                        tr.appendChild(td);
                    });
                } else if (row.type === 'service') {
                    // –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
                    const serviceName = row.name;
                    const service = serviceGroups[serviceName];
                    
                    th.innerHTML = `<strong>${serviceName}</strong>`;
                    th.innerHTML += ` <span class="delete-btn" onclick="deleteServiceGroup('${serviceName}')" title="–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–∏—Å">‚úñ</span>`;
                    tr.appendChild(th);
                    
                    experiments.forEach((exp, colIdx) => {
                        const td = document.createElement('td');
                        td.className = 'editable service-cell';
                        td.style.padding = '4px 8px';
                        
                        let cellHtml = '';
                        
                        // –Ø–¥—Ä–∞
                        if (service.cores) {
                            const coresValue = tableData[service.cores][colIdx] || '-';
                            cellHtml += `<div style="border-bottom: 1px solid #ddd; padding: 4px 0; text-align: center;" 
                                             ondblclick="event.stopPropagation(); makeEditableInline(this, '${service.cores}', ${colIdx})">
                                             ${coresValue}
                                         </div>`;
                        }
                        
                        // –ì–ë
                        if (service.memory) {
                            const memValue = tableData[service.memory][colIdx] || '-';
                            cellHtml += `<div style="padding: 4px 0; text-align: center;" 
                                             ondblclick="event.stopPropagation(); makeEditableInline(this, '${service.memory}', ${colIdx})">
                                             ${memValue}
                                         </div>`;
                        }
                        
                        td.innerHTML = cellHtml;
                        tr.appendChild(td);
                    });
                }
                
                tbody.appendChild(tr);
            });
            
            updateExperimentSelects();
            updateComparison(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
            saveToLocalStorage(); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        }
        
        function makeEditableInline(element, rowName, colIdx) {
            const currentValue = element.textContent.trim();
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            input.placeholder = '–ß–∏—Å–ª–æ –∏–ª–∏ %';
            input.style.width = '100%';
            input.onblur = function() {
                let newValue = this.value.trim();
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
                if (newValue && newValue.includes('%')) {
                    const percent = parseFloat(newValue.replace('%', '').trim());
                    if (!isNaN(percent)) {
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ —Å–∏—Å—Ç–µ–º—ã
                        let baseValue = 0;
                        
                        if (rowName.includes('(—è–¥—Ä–∞)')) {
                            baseValue = systemParams.cpu;
                        } else if (rowName.includes('(–ì–ë)')) {
                            baseValue = systemParams.ram;
                        }
                        
                        if (baseValue > 0) {
                            newValue = (baseValue * (percent / 100)).toFixed(2);
                        } else {
                            newValue = (percent / 100).toFixed(2);
                        }
                    }
                }
                
                if (!newValue) newValue = '-';
                
                tableData[rowName][colIdx] = newValue;
                recalculateTotals(colIdx);
                renderTable();
            };
            input.onkeydown = function(e) {
                if (e.key === 'Enter') {
                    this.blur();
                }
                if (e.key === 'Escape') {
                    renderTable();
                }
            };
            element.innerHTML = '';
            element.appendChild(input);
            input.focus();
            input.select();
        }
        
        function makeEditable(cell, rowName, colIdx, isTotal) {
            // –ï—Å–ª–∏ —ç—Ç–æ –∏—Ç–æ–≥–æ–≤–∞—è —è—á–µ–π–∫–∞, –±–µ—Ä–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ tableData, —á—Ç–æ–±—ã –Ω–µ –ø–∞—Ä—Å–∏—Ç—å HTML
            let currentValue;
            if (isTotal) {
                currentValue = tableData[rowName][colIdx] || '-';
            } else {
                currentValue = cell.textContent.trim();
            }
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            input.placeholder = '–ß–∏—Å–ª–æ –∏–ª–∏ %';
            input.style.width = '100%';
            input.style.textAlign = 'center';
            
            input.onblur = function() {
                let newValue = this.value.trim();
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
                if (newValue && newValue.includes('%')) {
                    const percent = parseFloat(newValue.replace('%', '').trim());
                    if (!isNaN(percent)) {
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ —Å–∏—Å—Ç–µ–º—ã
                        let baseValue = 0;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Å —è–¥—Ä–∞–º–∏ –∏–ª–∏ –ø–∞–º—è—Ç—å—é
                        if (rowName.includes('(—è–¥—Ä–∞)') || rowName === '–ò–¢–û–ì–û –Ø–î–†–ê') {
                            // –î–ª—è —è–¥–µ—Ä –±–µ—Ä–µ–º CPU –∏–∑ —Å–∏—Å—Ç–µ–º—ã
                            baseValue = systemParams.cpu;
                        } else if (rowName.includes('(–ì–ë)') || rowName === '–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨') {
                            // –î–ª—è –ø–∞–º—è—Ç–∏ –±–µ—Ä–µ–º RAM –∏–∑ —Å–∏—Å—Ç–µ–º—ã
                            baseValue = systemParams.ram;
                        } else {
                            // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–æ–∫ (–¢–µ–≥–æ–≤, –ò–∑–º/—Å–µ–∫ –∏ —Ç.–¥.) –±–µ—Ä–µ–º –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
                            if (colIdx > 0) {
                                const firstValue = tableData[rowName][0];
                                baseValue = parseFloat(firstValue);
                                if (isNaN(baseValue)) baseValue = 0;
                            }
                        }
                        
                        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –±–∞–∑—ã
                        if (baseValue > 0) {
                            newValue = (baseValue * (percent / 100)).toFixed(2);
                        } else {
                            // –ï—Å–ª–∏ –±–∞–∑–∞ = 0, –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –∫–∞–∫ –µ—Å—Ç—å
                            newValue = (percent / 100).toFixed(2);
                        }
                        
                        // –î–ª—è —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª —É–±–∏—Ä–∞–µ–º –¥—Ä–æ–±–Ω—É—é —á–∞—Å—Ç—å
                        if (rowName === '–¢–µ–≥–æ–≤' || rowName === '–ò–∑–º/—Å–µ–∫' || rowName === '–ê–ª–∞—Ä/—Å–µ–∫') {
                            newValue = Math.round(parseFloat(newValue)).toString();
                        }
                    }
                }
                
                // –ï—Å–ª–∏ –ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —Å—Ç–∞–≤–∏–º –ø—Ä–æ—á–µ—Ä–∫
                if (!newValue) newValue = '-';
                
                tableData[rowName][colIdx] = newValue;
                
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å–∞ (—è–¥—Ä–∞ –∏–ª–∏ –ì–ë)
                if (!isTotal && (rowName.includes('(—è–¥—Ä–∞)') || rowName.includes('(–ì–ë)'))) {
                    recalculateTotals(colIdx);
                }
                
                renderTable();
            };
            input.onkeydown = function(e) {
                if (e.key === 'Enter') {
                    this.blur();
                }
                if (e.key === 'Escape') {
                    renderTable();
                }
            };
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            input.select();
        }
        
        function recalculateTotals(colIdx) {
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ (–æ–ø—ã—Ç–∞)
            let totalCores = 0;
            let totalMemory = 0;
            
            Object.keys(tableData).forEach(rowName => {
                // –°—É–º–º–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
                if (rowName.includes('(—è–¥—Ä–∞)')) {
                    const val = parseFloat(tableData[rowName][colIdx]);
                    if (!isNaN(val)) {
                        totalCores += val;
                    }
                } else if (rowName.includes('(–ì–ë)')) {
                    const val = parseFloat(tableData[rowName][colIdx]);
                    if (!isNaN(val)) {
                        totalMemory += val;
                    }
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏
            if (tableData['–ò–¢–û–ì–û –Ø–î–†–ê']) {
                tableData['–ò–¢–û–ì–û –Ø–î–†–ê'][colIdx] = totalCores.toFixed(2);
            }
            if (tableData['–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨']) {
                tableData['–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨'][colIdx] = totalMemory.toFixed(2);
            }
        }
        
        function deleteServiceGroup(serviceName) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–∏—Å "${serviceName}" (–≤–∫–ª—é—á–∞—è —Å—Ç—Ä–æ–∫–∏ —Å —è–¥—Ä–∞–º–∏ –∏ –ì–ë)?`)) {
                delete tableData[serviceName + ' (—è–¥—Ä–∞)'];
                delete tableData[serviceName + ' (–ì–ë)'];
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ –∏—Ç–æ–≥–∏
                for (let i = 0; i < experiments.length; i++) {
                    recalculateTotals(i);
                }
                renderTable();
            }
        }
        
        function addExperiment() {
            const name = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–ø—ã—Ç–∞:', '‚ÑñX: –ù–∞–∑–≤–∞–Ω–∏–µ');
            if (name && name.trim()) {
                experiments.push(name.trim());
                Object.keys(tableData).forEach(key => {
                    if (tableData[key].type !== 'section') {
                        tableData[key].push('-');
                    }
                });
                renderTable();
                saveToLocalStorage(); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            }
        }
        
        function deleteExperiment(idx) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –æ–ø—ã—Ç "${experiments[idx]}"?`)) {
                experiments.splice(idx, 1);
                Object.keys(tableData).forEach(key => {
                    if (tableData[key].type !== 'section') {
                        tableData[key].splice(idx, 1);
                    }
                });
                renderTable();
            }
        }
        
        function addService() {
            const baseName = prompt('–í–≤–µ–¥–∏—Ç–µ –ë–ê–ó–û–í–û–ï –∏–º—è —Å–µ—Ä–≤–∏—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "new-service-01"). –°—Ç—Ä–æ–∫–∏ "(—è–¥—Ä–∞)" –∏ "(–ì–ë)" —Å–æ–∑–¥–∞–¥—É—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:', 'new-service-01');
            if (!baseName || !baseName.trim()) return;
            
            const name = baseName.trim();
            const coresKey = `${name} (—è–¥—Ä–∞)`;
            const memoryKey = `${name} (–ì–ë)`;
            
            const keys = Object.keys(tableData);
            const newTableData = {};
            let inserted = false;
            
            for (let i = 0; i < keys.length; i++) {
                const key = keys[i];
                newTableData[key] = tableData[key];
                
                const isServiceRow = (key.includes('(—è–¥—Ä–∞)') || key.includes('(–ì–ë)')) && !key.includes('–ò–¢–û–ì–û');
                const nextKey = keys[i + 1];
                const nextIsServiceRow = nextKey && (nextKey.includes('(—è–¥—Ä–∞)') || nextKey.includes('(–ì–ë)')) && !nextKey.includes('–ò–¢–û–ì–û');
                
                if (isServiceRow && !nextIsServiceRow && !inserted) {
                    newTableData[coresKey] = new Array(experiments.length).fill('-');
                    newTableData[memoryKey] = new Array(experiments.length).fill('-');
                    inserted = true;
                } else if (key === '–°–ï–†–í–ò–°–´' && !inserted && (!nextKey || !(nextKey.includes('(—è–¥—Ä–∞)') || nextKey.includes('(–ì–ë)')))) {
                    // –ù–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ - –≤—Å—Ç–∞–≤–ª—è–µ–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–µ–∫—Ü–∏–∏
                    newTableData[coresKey] = new Array(experiments.length).fill('-');
                    newTableData[memoryKey] = new Array(experiments.length).fill('-');
                    inserted = true;
                }
            }
            
            if (!inserted) {
                // –ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–µ –±—ã–ª–æ, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü
                newTableData[coresKey] = new Array(experiments.length).fill('-');
                newTableData[memoryKey] = new Array(experiments.length).fill('-');
            }
            
            tableData = newTableData;
            renderTable();
            saveToLocalStorage();
        }
        
        function deleteRow(rowName) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É "${rowName}"?`)) {
                delete tableData[rowName];
                renderTable();
            }
        }
        
        function exportToCSV() {
            let csv = '\ufeff'; // BOM –¥–ª—è Windows-1251
            
            // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã
            csv += `–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã:;CPU=${systemParams.cpu};RAM=${systemParams.ram}\n`;
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            csv += '–ü–∞—Ä–∞–º–µ—Ç—Ä/–°–µ—Ä–≤–∏—Å;' + experiments.join(';') + '\n';
            
            // –î–∞–Ω–Ω—ã–µ - –∑–∞–º–µ–Ω—è–µ–º —Ç–æ—á–∫–∏ –Ω–∞ –∑–∞–ø—è—Ç—ã–µ –¥–ª—è —á–∏—Å–µ–ª
            Object.keys(tableData).forEach(rowName => {
                if (tableData[rowName].type === 'section') {
                    csv += rowName + '\n';
                } else {
                    const values = tableData[rowName].map(val => {
                        // –ï—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ —Å —Ç–æ—á–∫–æ–π, –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ –∑–∞–ø—è—Ç—É—é –∏ –¥–æ–±–∞–≤–ª—è–µ–º = –¥–ª—è Excel
                        if (val !== '-' && !isNaN(parseFloat(val.replace(',', '.')))) {
                            return '="' + val.replace('.', ',') + '"';
                        }
                        return val;
                    });
                    csv += rowName + ';' + values.join(';') + '\n';
                }
            });
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ Windows-1251
            const blob = new Blob([csv], { type: 'text/csv;charset=windows-1251;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = '—Ç–∞–±–ª–∏—Ü–∞_–æ–ø—ã—Ç–æ–≤_' + new Date().toISOString().slice(0,10) + '.csv';
            link.click();
        }
        
        function exportToMarkdown() {
            let md = '# –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ–ø—ã—Ç–æ–≤ —Å –ø–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π —Ä–∞–∑–±–∏–≤–∫–æ–π\n\n';
            md += `**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã**: ${systemParams.cpu} —è–¥—Ä–∞ CPU, ${systemParams.ram} –ì–ë RAM\n\n`;
            md += '**–î–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞**: ' + new Date().toLocaleString('ru-RU') + '\n\n';
            md += '---\n\n';
            
            // –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
            md += '| –ü–∞—Ä–∞–º–µ—Ç—Ä/–°–µ—Ä–≤–∏—Å (—è–¥—Ä–∞/–ì–ë) | ' + experiments.join(' | ') + ' |\n';
            md += '|---' + experiments.map(() => '|---').join('') + '|\n';
            
            Object.keys(tableData).forEach(rowName => {
                if (tableData[rowName].type === 'section') {
                    md += '| **' + rowName + '** |' + experiments.map(() => '').join('|') + '|\n';
                } else {
                    md += '| ' + rowName + ' | ' + tableData[rowName].join(' | ') + ' |\n';
                }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω—ã –æ–ø—ã—Ç—ã
            const idx1 = document.getElementById('experiment1Select').value;
            const idx2 = document.getElementById('experiment2Select').value;
            
            if (idx1 && idx2 && idx1 !== idx2) {
                md += '\n---\n\n';
                md += '## üìä –ê–Ω–∞–ª–∏–∑ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –æ–ø—ã—Ç–æ–≤\n\n';
                md += generateComparisonMarkdown(idx1, idx2);
            }
            
            // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
            const blob = new Blob([md], { type: 'text/markdown;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = '—Ç–∞–±–ª–∏—Ü–∞_–æ–ø—ã—Ç–æ–≤_' + new Date().toISOString().slice(0,10) + '.md';
            link.click();
        }
        
        function generateComparisonMarkdown(idx1, idx2) {
            const exp1 = experiments[idx1];
            const exp2 = experiments[idx2];
            
            let md = `### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: ${exp1} ‚Üî ${exp2}\n\n`;
            
            // –ò—Ç–æ–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
            const cores1 = (tableData['–ò–¢–û–ì–û –Ø–î–†–ê'] && tableData['–ò–¢–û–ì–û –Ø–î–†–ê'][idx1]) ? parseFloat(tableData['–ò–¢–û–ì–û –Ø–î–†–ê'][idx1]) : 0;
            const cores2 = (tableData['–ò–¢–û–ì–û –Ø–î–†–ê'] && tableData['–ò–¢–û–ì–û –Ø–î–†–ê'][idx2]) ? parseFloat(tableData['–ò–¢–û–ì–û –Ø–î–†–ê'][idx2]) : 0;
            const mem1 = (tableData['–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨'] && tableData['–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨'][idx1]) ? parseFloat(tableData['–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨'][idx1]) : 0;
            const mem2 = (tableData['–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨'] && tableData['–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨'][idx2]) ? parseFloat(tableData['–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨'][idx2]) : 0;
            
            const coresDiff = cores2 - cores1;
            const memDiff = mem2 - mem1;
            const coresPercent = cores1 > 0 ? ((coresDiff / cores1) * 100).toFixed(1) : (cores2 > 0 ? '‚àû' : '0');
            const memPercent = mem1 > 0 ? ((memDiff / mem1) * 100).toFixed(1) : (mem2 > 0 ? '‚àû' : '0');
            
            md += '#### –ò—Ç–æ–≥–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏\n\n';
            md += '| –ú–µ—Ç—Ä–∏–∫–∞ | ' + exp1 + ' | ' + exp2 + ' | –ò–∑–º–µ–Ω–µ–Ω–∏–µ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ (%) |\n';
            md += '|---------|------------|------------|-----------|---------------|\n';
            md += `| **–Ø–¥—Ä–∞ CPU** | ${cores1} | ${cores2} | ${coresDiff > 0 ? '+' : ''}${coresDiff.toFixed(2)} | ${coresPercent > 0 ? '+' : ''}${coresPercent}% |\n`;
            md += `| **–ü–∞–º—è—Ç—å (–ì–ë)** | ${mem1} | ${mem2} | ${memDiff > 0 ? '+' : ''}${memDiff.toFixed(2)} | ${memPercent > 0 ? '+' : ''}${memPercent}% |\n\n`;
            
            // –£—Å–ª–æ–≤–∏—è –æ–ø—ã—Ç–æ–≤
            md += '#### –£—Å–ª–æ–≤–∏—è –æ–ø—ã—Ç–æ–≤\n\n';
            md += '| –ü–∞—Ä–∞–º–µ—Ç—Ä | ' + exp1 + ' | ' + exp2 + ' | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |\n';
            md += '|----------|------------|------------|----------|\n';
            
            const conditions = ['–¢–µ–≥–æ–≤', '–ò–∑–º/—Å–µ–∫', '–ê–ª–∞—Ä/—Å–µ–∫', 'UI'];
            conditions.forEach(cond => {
                if (tableData[cond] && tableData[cond][idx1] !== undefined && tableData[cond][idx2] !== undefined) {
                    const val1 = tableData[cond][idx1] || '-';
                    const val2 = tableData[cond][idx2] || '-';
                    const num1 = parseFloat(String(val1).replace(/\s/g, ''));
                    const num2 = parseFloat(String(val2).replace(/\s/g, ''));
                    let change = '-';
                    if (!isNaN(num1) && !isNaN(num2)) {
                        const diff = num2 - num1;
                        change = diff > 0 ? `+${diff}` : `${diff}`;
                    } else if (val1 !== val2) {
                        change = `${val1} ‚Üí ${val2}`;
                    } else {
                        change = '–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π';
                    }
                    md += `| ${cond} | ${val1} | ${val2} | ${change} |\n`;
                }
            });
            
            // –†–∞—Å—á–µ—Ç–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            md += '\n#### –†–∞—Å—á–µ—Ç–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n\n';
            
            const signals1 = (tableData['–¢–µ–≥–æ–≤'] && tableData['–¢–µ–≥–æ–≤'][idx1]) ? parseFloat(String(tableData['–¢–µ–≥–æ–≤'][idx1]).replace(/\s/g, '')) : 1;
            const signals2 = (tableData['–¢–µ–≥–æ–≤'] && tableData['–¢–µ–≥–æ–≤'][idx2]) ? parseFloat(String(tableData['–¢–µ–≥–æ–≤'][idx2]).replace(/\s/g, '')) : 1;
            const changes1 = (tableData['–ò–∑–º/—Å–µ–∫'] && tableData['–ò–∑–º/—Å–µ–∫'][idx1]) ? parseFloat(tableData['–ò–∑–º/—Å–µ–∫'][idx1]) : 0;
            const changes2 = (tableData['–ò–∑–º/—Å–µ–∫'] && tableData['–ò–∑–º/—Å–µ–∫'][idx2]) ? parseFloat(tableData['–ò–∑–º/—Å–µ–∫'][idx2]) : 0;
            const alarms1 = (tableData['–ê–ª–∞—Ä/—Å–µ–∫'] && tableData['–ê–ª–∞—Ä/—Å–µ–∫'][idx1]) ? parseFloat(tableData['–ê–ª–∞—Ä/—Å–µ–∫'][idx1]) : 0;
            const alarms2 = (tableData['–ê–ª–∞—Ä/—Å–µ–∫'] && tableData['–ê–ª–∞—Ä/—Å–µ–∫'][idx2]) ? parseFloat(tableData['–ê–ª–∞—Ä/—Å–µ–∫'][idx2]) : 0;
            
            const coresPerMSignal1 = (cores1 / (signals1 / 1000)).toFixed(6);
            const coresPerMSignal2 = (cores2 / (signals2 / 1000)).toFixed(6);
            const memPerMSignal1 = (mem1 / (signals1 / 1000)).toFixed(4);
            const memPerMSignal2 = (mem2 / (signals2 / 1000)).toFixed(4);
            
            md += '| –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å | ' + exp1 + ' | ' + exp2 + ' |\n';
            md += '|------------|------------|------------|\n';
            md += `| **–Ø–¥—Ä–∞ –Ω–∞ 1 —Ç—ã—Å. —Ç–µ–≥–æ–≤** | ${coresPerMSignal1} | ${coresPerMSignal2} |\n`;
            md += `| **–ì–ë –Ω–∞ 1 —Ç—ã—Å. —Ç–µ–≥–æ–≤** | ${memPerMSignal1} | ${memPerMSignal2} |\n`;
            
            if (changes1 > 0 && changes2 > 0) {
                const coresPerChange1 = (cores1 / changes1).toFixed(6);
                const coresPerChange2 = (cores2 / changes2).toFixed(6);
                md += `| **–Ø–¥—Ä–∞ –Ω–∞ 1 –∏–∑–º–µ–Ω–µ–Ω–∏–µ/—Å–µ–∫** | ${coresPerChange1} | ${coresPerChange2} |\n`;
            }
            
            if (alarms1 > 0 && alarms2 > 0) {
                const coresPerAlarm1 = (cores1 / alarms1).toFixed(4);
                const coresPerAlarm2 = (cores2 / alarms2).toFixed(4);
                md += `| **–Ø–¥—Ä–∞ –Ω–∞ 1 –∞–ª–∞—Ä–º/—Å–µ–∫** | ${coresPerAlarm1} | ${coresPerAlarm2} |\n`;
            }
            
            md += '\n';
            
            // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤
            md += '#### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º\n\n';
            md += '| –°–µ—Ä–≤–∏—Å | ' + exp1 + ' | ' + exp2 + ' | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |\n';
            md += '|--------|------------|------------|----------|\n';
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å—ã
            const serviceGroups = {};
            Object.keys(tableData).forEach(rowName => {
                const rowData = tableData[rowName];
                if (rowData && 
                    rowData.type !== 'section' && 
                    Array.isArray(rowData) &&
                    !rowName.includes('–ò–¢–û–ì–û') && 
                    !conditions.includes(rowName)) {
                    
                    let baseName = rowName;
                    let metricType = null;
                    
                    if (rowName.includes('(—è–¥—Ä–∞)')) {
                        baseName = rowName.replace(' (—è–¥—Ä–∞)', '');
                        metricType = 'cores';
                    } else if (rowName.includes('(–ì–ë)')) {
                        baseName = rowName.replace(' (–ì–ë)', '');
                        metricType = 'memory';
                    }
                    
                    if (!serviceGroups[baseName]) {
                        serviceGroups[baseName] = { cores: null, memory: null };
                    }
                    
                    if (metricType && rowData[idx1] !== undefined && rowData[idx2] !== undefined) {
                        serviceGroups[baseName][metricType] = {
                            val1: rowData[idx1] || '-',
                            val2: rowData[idx2] || '-'
                        };
                    }
                }
            });
            
            // –í—ã–≤–æ–¥–∏–º —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
            Object.keys(serviceGroups).forEach(serviceName => {
                const service = serviceGroups[serviceName];
                
                const hasCores = service.cores && (service.cores.val1 !== '-' || service.cores.val2 !== '-');
                const hasMemory = service.memory && (service.memory.val1 !== '-' || service.memory.val2 !== '-');
                
                if (hasCores || hasMemory) {
                    let val1Text = '';
                    let val2Text = '';
                    let changeText = '';
                    
                    if (hasCores) {
                        const coresVal1 = service.cores.val1;
                        const coresVal2 = service.cores.val2;
                        const coresNum1 = parseFloat(coresVal1) || 0;
                        const coresNum2 = parseFloat(coresVal2) || 0;
                        
                        val1Text += `**–Ø–¥—Ä–∞:** ${coresVal1}`;
                        val2Text += `**–Ø–¥—Ä–∞:** ${coresVal2}`;
                        
                        if (coresVal1 !== '-' && coresVal2 !== '-') {
                            const diff = coresNum2 - coresNum1;
                            changeText += `–Ø–¥—Ä–∞: ${diff > 0 ? '+' : ''}${diff.toFixed(2)}`;
                        } else if (coresVal1 === '-' && coresVal2 !== '-') {
                            changeText += `–Ø–¥—Ä–∞: –ø–æ—è–≤–∏–ª–∏—Å—å (${coresVal2})`;
                        } else if (coresVal1 !== '-' && coresVal2 === '-') {
                            changeText += `–Ø–¥—Ä–∞: –∏—Å—á–µ–∑–ª–∏ (${coresVal1})`;
                        }
                    }
                    
                    if (hasMemory) {
                        const memVal1 = service.memory.val1;
                        const memVal2 = service.memory.val2;
                        const memNum1 = parseFloat(memVal1) || 0;
                        const memNum2 = parseFloat(memVal2) || 0;
                        
                        if (val1Text) val1Text += '<br>';
                        if (val2Text) val2Text += '<br>';
                        if (changeText) changeText += '<br>';
                        
                        val1Text += `**–ì–ë:** ${memVal1}`;
                        val2Text += `**–ì–ë:** ${memVal2}`;
                        
                        if (memVal1 !== '-' && memVal2 !== '-') {
                            const diff = memNum2 - memNum1;
                            changeText += `–ì–ë: ${diff > 0 ? '+' : ''}${diff.toFixed(2)}`;
                        } else if (memVal1 === '-' && memVal2 !== '-') {
                            changeText += `–ì–ë: –ø–æ—è–≤–∏–ª–∏—Å—å (${memVal2})`;
                        } else if (memVal1 !== '-' && memVal2 === '-') {
                            changeText += `–ì–ë: –∏—Å—á–µ–∑–ª–∏ (${memVal1})`;
                        }
                    }
                    
                    md += `| **${serviceName}** | ${val1Text} | ${val2Text} | ${changeText || '-'} |\n`;
                }
            });
            
            md += '\n';
            
            return md;
        }
        
        // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É —Ñ–∞–π–ª–∞
        function detectDelimiter(text) {
            const lines = text.split(/\r?\n/).filter(l => l.trim());
            if (lines.length === 0) return ';';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–µ 2 —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è
            const testLines = lines.slice(0, Math.min(2, lines.length)).join('\n');
            
            // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π
            const tabCount = (testLines.match(/\t/g) || []).length;
            const semiCount = (testLines.match(/;/g) || []).length;
            const commaCount = (testLines.match(/,/g) || []).length;
            
            // –¢–∞–±—É–ª—è—Ü–∏—è –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑ Excel/—Ç–∞–±–ª–∏—Ü)
            if (tabCount >= 2) return '\t';
            // –¢–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π (—Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è —Ä—É—Å—Å–∫–æ–π –ª–æ–∫–∞–ª–∏ CSV)
            if (semiCount >= 2) return ';';
            // –ó–∞–ø—è—Ç–∞—è (–º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π CSV)
            if (commaCount >= 2) return ',';
            
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Ç–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π
            return ';';
        }
        
        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split(/\r?\n/).filter(l => l.trim());
                    
                    if (lines.length < 2) {
                        alert('–§–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞');
                        return;
                    }
                    
                    // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è
                    const delimiter = detectDelimiter(text);
                    console.log('üìä –û–ø—Ä–µ–¥–µ–ª–µ–Ω —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å:', delimiter === '\t' ? 'TAB' : delimiter);
                    
                    let startLine = 0;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã
                    if (lines[0].startsWith('–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã:') || lines[0].includes('CPU=')) {
                        const systemLine = lines[0].split(delimiter).map(cleanCSVCell);
                        // –ü–∞—Ä—Å–∏–º CPU –∏ RAM
                        systemLine.forEach(part => {
                            // –ò—â–µ–º CPU= –∏ RAM= –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ —á–∞—Å—Ç–∏
                            const cpuMatch = part.match(/CPU\s*=\s*(\d+(?:[.,]\d+)?)/i);
                            const ramMatch = part.match(/RAM\s*=\s*(\d+(?:[.,]\d+)?)/i);
                            
                            if (cpuMatch) {
                                const cpu = parseLocaleNumber(cpuMatch[1]);
                                if (cpu !== null) systemParams.cpu = cpu;
                            }
                            if (ramMatch) {
                                const ram = parseLocaleNumber(ramMatch[1]);
                                if (ram !== null) systemParams.ram = ram;
                            }
                        });
                        updateSystemParamsDisplay();
                        startLine = 1; // –ù–∞—á–∏–Ω–∞–µ–º —Å–æ –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–∏
                    }
                    
                    // –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                    const header = lines[startLine].split(delimiter);
                    experiments = header.slice(1).map(h => cleanCSVCell(h) || '-').filter(h => h && h !== '-');
                    
                    if (experiments.length === 0) {
                        alert('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∞–∑–≤–∞–Ω–∏—è –æ–ø—ã—Ç–æ–≤ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ');
                        return;
                    }
                    
                    // –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö
                    tableData = {};
                    for (let i = startLine + 1; i < lines.length; i++) {
                        const cols = lines[i].split(delimiter);
                        const rowName = cleanCSVCell(cols[0]);
                        if (!rowName) continue;
                        
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ —Å—Ç—Ä–æ–∫–∏ —Ç–æ–ª—å–∫–æ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏
                        const hasData = cols.slice(1).some(c => cleanCSVCell(c));
                        
                        if (cols.length === 1 || !hasData) {
                            // –°–µ–∫—Ü–∏—è (—Å—Ç—Ä–æ–∫–∞ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö)
                            tableData[rowName] = { type: 'section' };
                        } else {
                            const rawValues = cols.slice(1, experiments.length + 1); // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ–µ –∫–æ–ª-–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤
                            tableData[rowName] = rawValues.map((c, idx) => normalizeImportedValue(c, rowName, idx, rawValues));
                        }
                    }

                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏ –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–π (–ø—Ä–æ—Ü–µ–Ω—Ç—ã ‚Üí —á–∏—Å–ª–∞)
                    for (let col = 0; col < experiments.length; col++) {
                        recalculateTotals(col);
                    }
                    
                    renderTable();
                    saveToLocalStorage(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    
                    const delimName = delimiter === '\t' ? 'TAB' : (delimiter === ';' ? '—Ç–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π' : '–∑–∞–ø—è—Ç–∞—è');
                    alert(`–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!\n–§–æ—Ä–º–∞—Ç: ${delimName}\n–û–ø—ã—Ç–æ–≤: ${experiments.length}`);
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ: ' + error.message);
                    console.error('Import error:', error);
                }
            };
            
            // –ß–∏—Ç–∞–µ–º –≤ windows-1251 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è —Ä—É—Å—Å–∫–æ–π Windows/Excel)
            reader.readAsText(file, 'windows-1251');
            
            // –°–±—Ä–æ—Å–∏—Ç—å input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞
            event.target.value = '';
        }
        
        function resetTable() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–±—Ä–æ—à–µ–Ω—ã –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º.')) {
                location.reload();
            }
        }
        
        function updateExperimentSelects() {
            const select1 = document.getElementById('experiment1Select');
            const select2 = document.getElementById('experiment2Select');
            
            const currentValue1 = select1.value;
            const currentValue2 = select2.value;
            
            select1.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—ã—Ç --</option>';
            select2.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—ã—Ç --</option>';
            
            experiments.forEach((exp, idx) => {
                const option1 = document.createElement('option');
                option1.value = idx;
                option1.textContent = exp;
                select1.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = idx;
                option2.textContent = exp;
                select2.appendChild(option2);
            });
            
            select1.value = currentValue1;
            select2.value = currentValue2;
        }
        
        function updateComparison() {
            const idx1 = document.getElementById('experiment1Select').value;
            const idx2 = document.getElementById('experiment2Select').value;
            const resultDiv = document.getElementById('comparisonResult');
            
            if (!idx1 || !idx2) {
                resultDiv.innerHTML = '<p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∞ –æ–ø—ã—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</p>';
                return;
            }
            
            if (idx1 === idx2) {
                resultDiv.innerHTML = '<p style="color: #cf222e;">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–Ω—ã–µ –æ–ø—ã—Ç—ã</p>';
                return;
            }
            
            const exp1 = experiments[idx1];
            const exp2 = experiments[idx2];
            
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
            const cores1 = (tableData['–ò–¢–û–ì–û –Ø–î–†–ê'] && tableData['–ò–¢–û–ì–û –Ø–î–†–ê'][idx1]) ? parseFloat(tableData['–ò–¢–û–ì–û –Ø–î–†–ê'][idx1]) : 0;
            const cores2 = (tableData['–ò–¢–û–ì–û –Ø–î–†–ê'] && tableData['–ò–¢–û–ì–û –Ø–î–†–ê'][idx2]) ? parseFloat(tableData['–ò–¢–û–ì–û –Ø–î–†–ê'][idx2]) : 0;
            const mem1 = (tableData['–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨'] && tableData['–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨'][idx1]) ? parseFloat(tableData['–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨'][idx1]) : 0;
            const mem2 = (tableData['–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨'] && tableData['–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨'][idx2]) ? parseFloat(tableData['–ò–¢–û–ì–û –ü–ê–ú–Ø–¢–¨'][idx2]) : 0;
            
            const coresDiff = cores2 - cores1;
            const memDiff = mem2 - mem1;
            const coresPercent = cores1 > 0 ? ((coresDiff / cores1) * 100).toFixed(1) : (cores2 > 0 ? '‚àû' : '0');
            const memPercent = mem1 > 0 ? ((memDiff / mem1) * 100).toFixed(1) : (mem2 > 0 ? '‚àû' : '0');
            
            const coresClass = coresDiff >= 0 ? 'positive-change' : 'negative-change';
            const memClass = memDiff >= 0 ? 'positive-change' : 'negative-change';
            
            // –£—Å–ª–æ–≤–∏—è
            const signals1 = (tableData['–¢–µ–≥–æ–≤'] && tableData['–¢–µ–≥–æ–≤'][idx1]) ? parseFloat(String(tableData['–¢–µ–≥–æ–≤'][idx1]).replace(/\s/g, '')) : 1;
            const signals2 = (tableData['–¢–µ–≥–æ–≤'] && tableData['–¢–µ–≥–æ–≤'][idx2]) ? parseFloat(String(tableData['–¢–µ–≥–æ–≤'][idx2]).replace(/\s/g, '')) : 1;
            const changes1 = (tableData['–ò–∑–º/—Å–µ–∫'] && tableData['–ò–∑–º/—Å–µ–∫'][idx1]) ? parseFloat(tableData['–ò–∑–º/—Å–µ–∫'][idx1]) : 0;
            const changes2 = (tableData['–ò–∑–º/—Å–µ–∫'] && tableData['–ò–∑–º/—Å–µ–∫'][idx2]) ? parseFloat(tableData['–ò–∑–º/—Å–µ–∫'][idx2]) : 0;
            const alarms1 = (tableData['–ê–ª–∞—Ä/—Å–µ–∫'] && tableData['–ê–ª–∞—Ä/—Å–µ–∫'][idx1]) ? parseFloat(tableData['–ê–ª–∞—Ä/—Å–µ–∫'][idx1]) : 0;
            const alarms2 = (tableData['–ê–ª–∞—Ä/—Å–µ–∫'] && tableData['–ê–ª–∞—Ä/—Å–µ–∫'][idx2]) ? parseFloat(tableData['–ê–ª–∞—Ä/—Å–µ–∫'][idx2]) : 0;
            const ui1 = (tableData['UI'] && tableData['UI'][idx1]) ? tableData['UI'][idx1] : '-';
            const ui2 = (tableData['UI'] && tableData['UI'][idx2]) ? tableData['UI'][idx2] : '-';
            
            // –†–∞—Å—á–µ—Ç–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
            const coresPerMSignal1 = (cores1 / (signals1 / 1000)).toFixed(6);
            const coresPerMSignal2 = (cores2 / (signals2 / 1000)).toFixed(6);
            const memPerMSignal1 = (mem1 / (signals1 / 1000)).toFixed(4);
            const memPerMSignal2 = (mem2 / (signals2 / 1000)).toFixed(4);
            
            let html = `
                <h3>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ: ${exp1} ‚Üî ${exp2}</h3>
                
                <h4>üìä –ò—Ç–æ–≥–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h4>
                <table>
                    <thead>
                        <tr>
                            <th>–ú–µ—Ç—Ä–∏–∫–∞</th>
                            <th>${exp1}</th>
                            <th>${exp2}</th>
                            <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                            <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>–Ø–¥—Ä–∞ CPU</strong></td>
                            <td>${cores1}</td>
                            <td>${cores2}</td>
                            <td class="${coresClass}">${coresDiff > 0 ? '+' : ''}${coresDiff.toFixed(2)}</td>
                            <td class="${coresClass}">${coresPercent > 0 ? '+' : ''}${coresPercent}%</td>
                        </tr>
                        <tr>
                            <td><strong>–ü–∞–º—è—Ç—å (–ì–ë)</strong></td>
                            <td>${mem1}</td>
                            <td>${mem2}</td>
                            <td class="${memClass}">${memDiff > 0 ? '+' : ''}${memDiff.toFixed(2)}</td>
                            <td class="${memClass}">${memPercent > 0 ? '+' : ''}${memPercent}%</td>
                        </tr>
                    </tbody>
                </table>
                
                <h4>‚öôÔ∏è –£—Å–ª–æ–≤–∏—è –æ–ø—ã—Ç–æ–≤</h4>
                <table>
                    <thead>
                        <tr>
                            <th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
                            <th>${exp1}</th>
                            <th>${exp2}</th>
                            <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>–¢–µ–≥–æ–≤</strong></td>
                            <td>${signals1.toLocaleString('ru-RU')}</td>
                            <td>${signals2.toLocaleString('ru-RU')}</td>
                            <td>${signals2 - signals1 > 0 ? '+' : ''}${(signals2 - signals1).toLocaleString('ru-RU')}</td>
                        </tr>
                        <tr>
                            <td><strong>–ò–∑–º/—Å–µ–∫</strong></td>
                            <td>${changes1}</td>
                            <td>${changes2}</td>
                            <td>${changes2 - changes1 > 0 ? '+' : ''}${changes2 - changes1}</td>
                        </tr>
                        <tr>
                            <td><strong>–ê–ª–∞—Ä/—Å–µ–∫</strong></td>
                            <td>${alarms1}</td>
                            <td>${alarms2}</td>
                            <td>${alarms2 - alarms1 > 0 ? '+' : ''}${alarms2 - alarms1}</td>
                        </tr>
                        <tr>
                            <td><strong>UI</strong></td>
                            <td>${ui1}</td>
                            <td>${ui2}</td>
                            <td>${ui1 !== ui2 ? ui1 + ' ‚Üí ' + ui2 : '–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π'}</td>
                        </tr>
                    </tbody>
                </table>
                
                <h4>üìà –†–∞—Å—á–µ—Ç–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h4>
                <table>
                    <thead>
                        <tr>
                            <th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th>
                            <th>${exp1}</th>
                            <th>${exp2}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>–Ø–¥—Ä–∞ –Ω–∞ 1 —Ç—ã—Å. —Ç–µ–≥–æ–≤</strong></td>
                            <td>${coresPerMSignal1}</td>
                            <td>${coresPerMSignal2}</td>
                        </tr>
                        <tr>
                            <td><strong>–ì–ë –Ω–∞ 1 —Ç—ã—Å. —Ç–µ–≥–æ–≤</strong></td>
                            <td>${memPerMSignal1}</td>
                            <td>${memPerMSignal2}</td>
                        </tr>`;
            
            if (changes1 > 0 && changes2 > 0) {
                const coresPerChange1 = (cores1 / changes1).toFixed(6);
                const coresPerChange2 = (cores2 / changes2).toFixed(6);
                html += `
                        <tr>
                            <td><strong>–Ø–¥—Ä–∞ –Ω–∞ 1 –∏–∑–º–µ–Ω–µ–Ω–∏–µ/—Å–µ–∫</strong></td>
                            <td>${coresPerChange1}</td>
                            <td>${coresPerChange2}</td>
                        </tr>`;
            }
            
            if (alarms1 > 0 && alarms2 > 0) {
                const coresPerAlarm1 = (cores1 / alarms1).toFixed(4);
                const coresPerAlarm2 = (cores2 / alarms2).toFixed(4);
                html += `
                        <tr>
                            <td><strong>–Ø–¥—Ä–∞ –Ω–∞ 1 –∞–ª–∞—Ä–º/—Å–µ–∫</strong></td>
                            <td>${coresPerAlarm1}</td>
                            <td>${coresPerAlarm2}</td>
                        </tr>`;
            }
            
            html += `
                    </tbody>
                </table>
                
                <h4>üîß –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º</h4>
                <table>
                    <thead>
                        <tr>
                            <th>–°–µ—Ä–≤–∏—Å</th>
                            <th>${exp1}</th>
                            <th>${exp2}</th>
                            <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            const conditions = ['–¢–µ–≥–æ–≤', '–ò–∑–º/—Å–µ–∫', '–ê–ª–∞—Ä/—Å–µ–∫', 'UI'];
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å—ã: —Å–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä—ã (—è–¥—Ä–∞) –∏ (–ì–ë)
            const serviceGroups = {};
            Object.keys(tableData).forEach(rowName => {
                const rowData = tableData[rowName];
                if (rowData && 
                    rowData.type !== 'section' && 
                    Array.isArray(rowData) &&
                    !rowName.includes('–ò–¢–û–ì–û') && 
                    !conditions.includes(rowName)) {
                    
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –±–∞–∑–æ–≤–æ–µ –∏–º—è —Å–µ—Ä–≤–∏—Å–∞
                    let baseName = rowName;
                    let metricType = null;
                    
                    if (rowName.includes('(—è–¥—Ä–∞)')) {
                        baseName = rowName.replace(' (—è–¥—Ä–∞)', '');
                        metricType = 'cores';
                    } else if (rowName.includes('(–ì–ë)')) {
                        baseName = rowName.replace(' (–ì–ë)', '');
                        metricType = 'memory';
                    }
                    
                    if (!serviceGroups[baseName]) {
                        serviceGroups[baseName] = { cores: null, memory: null };
                    }
                    
                    if (metricType && rowData[idx1] !== undefined && rowData[idx2] !== undefined) {
                        serviceGroups[baseName][metricType] = {
                            val1: rowData[idx1] || '-',
                            val2: rowData[idx2] || '-'
                        };
                    }
                }
            });
            
            // –í—ã–≤–æ–¥–∏–º —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
            Object.keys(serviceGroups).forEach(serviceName => {
                const service = serviceGroups[serviceName];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ
                const hasCores = service.cores && (service.cores.val1 !== '-' || service.cores.val2 !== '-');
                const hasMemory = service.memory && (service.memory.val1 !== '-' || service.memory.val2 !== '-');
                
                if (hasCores || hasMemory) {
                    let val1Html = '';
                    let val2Html = '';
                    let changeHtml = '';
                    
                    // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —è—á–µ–µ–∫
                    if (hasCores) {
                        const coresVal1 = service.cores.val1;
                        const coresVal2 = service.cores.val2;
                        const coresNum1 = parseFloat(coresVal1) || 0;
                        const coresNum2 = parseFloat(coresVal2) || 0;
                        
                        val1Html += `<div><strong>–Ø–¥—Ä–∞:</strong> ${coresVal1}</div>`;
                        val2Html += `<div><strong>–Ø–¥—Ä–∞:</strong> ${coresVal2}</div>`;
                        
                        if (coresVal1 !== '-' && coresVal2 !== '-') {
                            const diff = coresNum2 - coresNum1;
                            const diffClass = diff >= 0 ? 'positive-change' : 'negative-change';
                            changeHtml += `<div class="${diffClass}">–Ø–¥—Ä–∞: ${diff > 0 ? '+' : ''}${diff.toFixed(2)}</div>`;
                        } else if (coresVal1 === '-' && coresVal2 !== '-') {
                            changeHtml += `<div class="positive-change">–Ø–¥—Ä–∞: –ø–æ—è–≤–∏–ª–∏—Å—å (${coresVal2})</div>`;
                        } else if (coresVal1 !== '-' && coresVal2 === '-') {
                            changeHtml += `<div class="negative-change">–Ø–¥—Ä–∞: –∏—Å—á–µ–∑–ª–∏ (${coresVal1})</div>`;
                        }
                    }
                    
                    if (hasMemory) {
                        const memVal1 = service.memory.val1;
                        const memVal2 = service.memory.val2;
                        const memNum1 = parseFloat(memVal1) || 0;
                        const memNum2 = parseFloat(memVal2) || 0;
                        
                        val1Html += `<div><strong>–ì–ë:</strong> ${memVal1}</div>`;
                        val2Html += `<div><strong>–ì–ë:</strong> ${memVal2}</div>`;
                        
                        if (memVal1 !== '-' && memVal2 !== '-') {
                            const diff = memNum2 - memNum1;
                            const diffClass = diff >= 0 ? 'positive-change' : 'negative-change';
                            changeHtml += `<div class="${diffClass}">–ì–ë: ${diff > 0 ? '+' : ''}${diff.toFixed(2)}</div>`;
                        } else if (memVal1 === '-' && memVal2 !== '-') {
                            changeHtml += `<div class="positive-change">–ì–ë: –ø–æ—è–≤–∏–ª–∏—Å—å (${memVal2})</div>`;
                        } else if (memVal1 !== '-' && memVal2 === '-') {
                            changeHtml += `<div class="negative-change">–ì–ë: –∏—Å—á–µ–∑–ª–∏ (${memVal1})</div>`;
                        }
                    }
                    
                    html += `
                        <tr>
                            <td><strong>${serviceName}</strong></td>
                            <td>${val1Html}</td>
                            <td>${val2Html}</td>
                            <td>${changeHtml || '-'}</td>
                        </tr>`;
                }
            });
            
            html += `
                    </tbody>
                </table>
                <p style="margin-top: 20px;"><em>üí° –°–æ–≤–µ—Ç: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–≠–∫—Å–ø–æ—Ä—Ç –≤ Markdown" –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</em></p>
            `;
            
            resultDiv.innerHTML = html;
        }
        
        function resetTable() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–±—Ä–æ—à–µ–Ω—ã –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º.')) {
                clearLocalStorage();
                location.reload();
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å LocalStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEY_EXPERIMENTS, JSON.stringify(experiments));
                localStorage.setItem(STORAGE_KEY_TABLE, JSON.stringify(tableData));
                localStorage.setItem(STORAGE_KEY_SYSTEM, JSON.stringify(systemParams));
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ LocalStorage:', error);
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const savedExperiments = localStorage.getItem(STORAGE_KEY_EXPERIMENTS);
                const savedTable = localStorage.getItem(STORAGE_KEY_TABLE);
                const savedSystem = localStorage.getItem(STORAGE_KEY_SYSTEM);
                
                if (savedExperiments && savedTable) {
                    experiments = JSON.parse(savedExperiments);
                    tableData = JSON.parse(savedTable);
                    if (savedSystem) {
                        systemParams = JSON.parse(savedSystem);
                        updateSystemParamsDisplay();
                    }
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞');
                    return true;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ LocalStorage:', error);
            }
            return false;
        }
        
        function clearLocalStorage() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à? –í—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –∏ –¥–∞–Ω–Ω—ã–µ –≤–µ—Ä–Ω—É—Ç—Å—è –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º.')) {
                localStorage.removeItem(STORAGE_KEY_EXPERIMENTS);
                localStorage.removeItem(STORAGE_KEY_TABLE);
                localStorage.removeItem(STORAGE_KEY_SYSTEM);
                alert('–ö—ç—à –æ—á–∏—â–µ–Ω. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞.');
                location.reload();
            }
        }
        
        function updateSystemParamsDisplay() {
            document.getElementById('cpu-value').textContent = systemParams.cpu;
            document.getElementById('ram-value').textContent = systemParams.ram;
        }
        
        function editSystemParam(param) {
            const names = {
                'cpu': '–Ø–¥—Ä–∞ CPU',
                'ram': '–ì–ë RAM',
                'valves': '–ó–∞–¥–≤–∏–∂–µ–∫',
                'combinations': '–°–µ–∫—É—â–∏—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π',
                'pressures': '–ü–∞—Ä –¥–∞–≤–ª–µ–Ω–∏–π'
            };
            
            const newValue = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è "${names[param]}":`, systemParams[param]);
            if (newValue !== null && newValue.trim() !== '') {
                const numValue = parseFloat(newValue);
                if (!isNaN(numValue) && numValue > 0) {
                    systemParams[param] = numValue;
                    updateSystemParamsDisplay();
                    saveToLocalStorage();
                } else {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ');
                }
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ LocalStorage
        const loaded = loadFromLocalStorage();
        if (loaded) {
            console.log('‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞');
        } else {
            console.log('‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
        }
        renderTable();
    </script>
</body>
</html>

