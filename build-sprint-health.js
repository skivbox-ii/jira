#!/usr/bin/env node
/**
 * Скрипт сборки ujg-sprint-health.js из модулей
 * Использование: node build-sprint-health.js
 */

var fs = require("fs");
var path = require("path");

var MODULES_DIR = path.join(__dirname, "ujg-sprint-health-modules");
var OUTPUT_FILE = path.join(__dirname, "ujg-sprint-health.js");

// Порядок загрузки модулей (важен для зависимостей)
var MODULE_ORDER = [
    "config.js",
    "utils.js",
    "storage.js",
    "api.js",
    "burndown.js",
    "charts-svg.js",
    "charts-canvas.js",
    "main.js"
];

function readModule(fileName) {
    var filePath = path.join(MODULES_DIR, fileName);
    if (!fs.existsSync(filePath)) {
        console.warn("Warning: Module not found:", fileName);
        return "";
    }
    return fs.readFileSync(filePath, "utf8");
}

function build() {
    console.log("Building ujg-sprint-health.js from modules...");

    var parts = [
        "// Auto-generated file - DO NOT EDIT MANUALLY",
        "// Generated by build-sprint-health.js",
        "// To modify, edit files in ujg-sprint-health-modules/ and rebuild",
        ""
    ];

    MODULE_ORDER.forEach(function(fileName) {
        var content = readModule(fileName);
        if (!content) return;
        parts.push("/* === Module: " + fileName + " === */");
        parts.push(content.trim());
        parts.push("");
    });

    // Финальный публичный модуль, который ожидает Jira (конструктор гаджета)
    parts.push('define("_ujgSprintHealth", ["_ujgSH_main"], function(MyGadget) {');
    parts.push('    "use strict";');
    parts.push("    return MyGadget;");
    parts.push("});");
    parts.push("");

    var fullContent = parts.join("\n");

    fs.writeFileSync(OUTPUT_FILE, fullContent, "utf8");

    console.log("✓ Built successfully:", OUTPUT_FILE);
    console.log("  Total size:", (fullContent.length / 1024).toFixed(2), "KB");
    console.log("  Modules processed:", MODULE_ORDER.filter(function(f) {
        return fs.existsSync(path.join(MODULES_DIR, f));
    }).length);
}

if (require.main === module) {
    build();
}

module.exports = { build: build };
